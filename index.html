<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Money Manager</title>
    
    <!-- Link to Manifest file -->
    <link rel="manifest" href="/manifest.json">

    <!-- Add PWA Icons meta tags (optional, but good practice for some browsers) -->
    <!-- These refer to the icons in your manifest.json -->
    <link rel="icon" href="/icons/icon-48x48.png" sizes="48x48" type="image/png">
    <link rel="icon" href="/icons/icon-72x72.png" sizes="72x72" type="image/png">
    <link rel="icon" href="/icons/icon-96x96.png" sizes="96x96" type="image/png">
    <link rel="icon" href="/icons/icon-144x144.png" sizes="144x144" type="image/png">
    <link rel="icon" href="/icons/icon-192x192.png" sizes="192x192" type="image/png">
    <link rel="icon" href="/icons/icon-384x384.png" sizes="384x384" type="image/png">
    <link rel="icon" href="/icons/icon-512x512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="/icons/icon-1024x1024.png" sizes="1024x1024" type="image/png">

    <!-- Apple Touch Icon for iOS homescreen -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Theme color meta tag for Android browser UI -->
    <meta name="theme-color" content="#007bff">
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- Color Palette and Typography --- */
        :root {
            --primary: #007bff; /* Bootstrap primary blue */
            --primary-dark: #0056b3; /* Darker shade of primary */
            --secondary: #6c757d; /* Bootstrap secondary gray */
            --danger: #dc3545; /* Bootstrap danger red */
            --light-gray: #f8f9fa; /* Very light gray for backgrounds */
            --medium-gray: #e9ecef; /* Light gray for borders and dividers */
            --dark-gray: #495057; /* Dark gray for secondary text */
            --text: #212529; /* Bootstrap primary text color */
            --text-light: #6c757d; /* Lighter text color */
            --positive: #28a745; /* Bootstrap success green */
            --negative: #dc3545; /* Bootstrap danger red */
            --card-background: #ffffff; /* White background for cards and content blocks */
            --input-border-color: #ced4da; /* Standard input border color */
            --input-focus-border-color: var(--primary); /* Primary color on input focus */
            --button-hover-bg: var(--primary-dark); /* Darker primary on button hover */
            --transition-fast: 0.2s ease-in-out; /* Fast transition for smooth effects */
            --modal-background: rgba(0, 0, 0, 0.8); /* Semi-transparent dark background for modals */
            --border-radius-default: 6px; /* Standard border radius */
            --border-radius-large: 10px; /* Larger border radius for main containers */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1); /* Small shadow for subtle depth */
            --shadow-md: 0 2px 5px rgba(0,0,0,0.15); /* Medium shadow for cards and headers */
            --dark-mode-bg: #1a1a1a; /* Dark mode background */
            --dark-mode-card-bg: #2c2c2c; /* Dark mode card background */
            --dark-mode-text: #e0e0e0; /* Dark mode text color */
            --dark-mode-primary: #4dabf7; /* Lighter blue for dark mode */
            --dark-mode-primary-dark: #228be6; /* Darker blue for dark mode */
            --dark-mode-secondary: #868e96; /* Dark mode secondary gray */
            --dark-mode-border-color: #495057; /* Dark mode input border */
            --dark-mode-input-focus-border-color: var(--dark-mode-primary);
            --dark-mode-button-hover-bg: var(--dark-mode-primary-dark);
        }

        /* --- Global Reset and Base Styles --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--light-gray); /* Light background for the entire page */
            color: var(--text); /* Default text color */
            line-height: 1.5; /* Comfortable line spacing */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            font-size: 14px; /* Base font size, can be adjusted */
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        body.dark-mode {
            background-color: var(--dark-mode-bg);
            color: var(--dark-mode-text);
        }

        /* --- Lock Screen Styles --- */
        #lock-screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-background); /* Dimmed background */
            color: white; /* Text color for lock screen */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Ensure it's on top of everything */
            opacity: 0; /* Initially hidden */
            visibility: hidden; /* Initially not interactive */
            transition: opacity var(--transition-fast); /* Smooth fade effect */
            backdrop-filter: blur(5px); /* Apply blur effect to the background behind the overlay */
            -webkit-backdrop-filter: blur(5px); /* For Safari compatibility */
        }

        #lock-screen-overlay.visible {
            opacity: 1; /* Make visible */
            visibility: visible; /* Make interactive */
        }

        #lock-screen-content {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1); /* Slightly translucent white background */
            padding: 20px;
            border-radius: var(--border-radius-large); /* Rounded corners */
            width: 90%;
            max-width: 350px; /* Max width for content */
            box-shadow: 0 0 15px rgba(0,0,0,0.3); /* Shadow for depth */
        }

        body.dark-mode #lock-screen-content {
             background-color: rgba(44, 44, 44, 0.4); /* Darker translucent background for dark mode */
             box-shadow: 0 0 15px rgba(0,0,0,0.7); /* Darker shadow for dark mode */
        }

        #lock-screen-title {
            font-size: 1.8rem; /* Large font size for title */
            margin-bottom: 15px;
            font-weight: 600; /* Bold */
            color: white; /* White text */
        }

        #lock-screen-message {
            font-size: 1rem; /* Standard font size for message */
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
        }

        #lock-screen-pin-input {
            font-size: 1.8rem; /* Large font for PIN display */
            letter-spacing: 10px; /* Space between PIN digits */
            padding: 12px 15px;
            border: 2px solid var(--primary); /* Primary colored border */
            border-radius: var(--border-radius-default);
            background-color: transparent; /* Transparent background */
            color: white; /* White text */
            width: 100%;
            max-width: 200px; /* Fixed width for PIN input */
            text-align: center;
            margin-bottom: 15px;
            caret-color: transparent; /* Hide caret */
        }

        body.dark-mode #lock-screen-pin-input {
            border-color: var(--dark-mode-primary); /* Dark mode primary border */
        }

        #lock-screen-keyboard {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #lock-screen-keyboard .key-row {
            display: flex;
            justify-content: center; /* Center keys horizontally */
            margin-bottom: 10px;
        }

        #lock-screen-keyboard button {
            width: 60px;
            height: 60px;
            font-size: 1.5rem; /* Large font for key numbers */
            background-color: rgba(255, 255, 255, 0.1); /* Translucent white keys */
            color: white;
            border: none;
            border-radius: 50%; /* Circular buttons */
            margin: 0 5px; /* Spacing between keys */
            display: flex;
            align-items: center;
            justify-content: center; /* Center content within button */
            cursor: pointer;
        }

        body.dark-mode #lock-screen-keyboard button {
            background-color: rgba(255, 255, 255, 0.1); /* Keep translucency for dark mode */
            color: var(--dark-mode-text); /* Dark mode text color */
        }

        #lock-screen-keyboard button:active {
            background-color: rgba(255, 255, 255, 0.2); /* Slightly darker on press */
        }

        #lock-screen-keyboard .key-delete {
            background-color: var(--danger); /* Red background for delete key */
        }

        #lock-screen-keyboard .key-delete:active {
            background-color: #c82333; /* Darker red on press */
        }

        #lock-screen-error-message {
            color: #ffc107; /* Warning yellow for errors */
            min-height: 20px; /* Reserve space for error message */
            margin: 10px 0;
            font-size: 0.9rem;
        }

        #lock-screen-footer {
            margin-top: 20px; /* Space above footer */
            font-size: 0.8rem; /* Smaller font size for footer */
            color: rgba(255, 255, 255, 0.7); /* Slightly transparent white */
        }

        /* --- Main Layout and Navigation --- */
        .container {
            width: 100%;
            margin: 0 auto; /* Center the container */
            padding: 10px; /* Padding around the content */
            background-color: var(--card-background); /* White background */
            transition: background-color var(--transition-fast);
        }

        body.dark-mode .container {
            background-color: var(--dark-mode-card-bg); /* Dark mode card background */
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Gradient header background */
            color: white; /* White text for header */
            padding: 20px 15px;
            border-radius: var(--border-radius-large); /* Rounded corners */
            box-shadow: var(--shadow-md); /* Medium shadow */
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, var(--dark-mode-primary) 0%, var(--dark-mode-primary-dark) 100%); /* Dark mode gradient */
        }

        .header h1 {
            font-weight: 600; /* Semi-bold */
            margin-bottom: 10px;
            font-size: 1.8rem; /* Large font for title */
        }

        .header p {
            font-size: 1rem; /* Standard font size for subtitle */
            opacity: 0.9; /* Slightly transparent */
        }

        /* --- Tabs --- */
        .tabs-container, .tabs-container-bottom {
            display: flex; /* Use flexbox for tab layout */
            justify-content: space-around; /* Distribute tabs evenly */
            gap: 8px; /* Spacing between tabs */
            margin-bottom: 15px; /* Space below tabs */
            padding: 0 5px; /* Add some horizontal padding */
        }

        .tabs-container-bottom {
            justify-content: center; /* Center bottom tabs */
        }

        .tab {
            flex: 1; /* Allow tabs to grow and fill space */
            padding: 15px 10px; /* Larger padding for tabs */
            cursor: pointer; /* Indicate clickable element */
            text-align: center; /* Center text */
            font-weight: 500; /* Medium font weight */
            color: var(--dark-gray); /* Dark gray text */
            background-color: var(--light-gray); /* Light gray background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            transition: color var(--transition-fast), background-color var(--transition-fast), border-color var(--transition-fast); /* Smooth transitions */
            font-size: 0.9rem; /* Slightly larger font for tabs */
            white-space: nowrap; /* Prevent text wrapping */
            border-bottom: 3px solid transparent; /* Transparent border for active indicator */
        }

        body.dark-mode .tab {
            color: var(--dark-mode-text); /* Dark mode text */
            background-color: var(--dark-mode-card-bg); /* Dark mode background for tabs */
        }

        .tab.active {
            color: var(--primary); /* Primary color for active tab text */
            background-color: var(--card-background); /* White background for active tab */
            border-bottom-color: var(--primary); /* Primary border color as indicator */
            box-shadow: var(--shadow-md); /* Slightly larger shadow for active tab */
        }

        body.dark-mode .tab.active {
            color: var(--dark-mode-primary); /* Dark mode primary color for active tab */
            background-color: var(--dark-mode-card-bg); /* Keep dark mode background */
            border-bottom-color: var(--dark-mode-primary); /* Dark mode primary border */
            box-shadow: var(--shadow-md); /* Maintain shadow */
        }

        .tab:hover {
            background-color: var(--medium-gray); /* Light gray hover effect */
            color: var(--primary); /* Primary color on hover */
        }

        body.dark-mode .tab:hover {
            background-color: var(--dark-mode-secondary); /* Darker hover for dark mode */
            color: var(--dark-mode-primary);
        }

        .tab.active:hover {
            background-color: var(--card-background); /* Maintain white background for active tab on hover */
        }

        body.dark-mode .tab.active:hover {
            background-color: var(--dark-mode-card-bg); /* Maintain dark mode background */
        }

        .tab-content {
            display: none; /* Hide content by default */
            padding: 15px;
            background-color: var(--card-background); /* White background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            transition: opacity var(--transition-fast); /* For potential future animations */
        }

        body.dark-mode .tab-content {
            background-color: var(--dark-mode-card-bg); /* Dark mode card background */
        }

        .tab-content.active {
            display: block; /* Show active tab content */
        }

        /* --- Card Styles --- */
        .card-container {
            display: grid; /* Use grid for card layout */
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive columns */
            gap: 10px; /* Spacing between cards */
            margin-bottom: 15px; /* Space below card container */
        }

        .card {
            background: var(--card-background); /* White background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            padding: 15px; /* Padding inside card */
            text-align: center; /* Center content */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .card {
            background-color: var(--dark-mode-card-bg); /* Dark mode card background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .card h3 {
            font-size: 0.9rem; /* Small font size for card title */
            color: var(--dark-gray); /* Dark gray text */
            margin-bottom: 8px;
            font-weight: 500; /* Medium font weight */
        }

        body.dark-mode .card h3 {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
        }

        .card-amount {
            font-size: 1.4rem; /* Larger font size for amounts */
            font-weight: 600; /* Semi-bold */
        }

        /* --- Form Section Styles --- */
        .form-section {
            background: var(--card-background); /* White background */
            padding: 15px;
            border-radius: var(--border-radius-default); /* Rounded corners */
            margin-bottom: 15px; /* Space below section */
            box-shadow: var(--shadow-sm); /* Small shadow */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .form-section {
            background-color: var(--dark-mode-card-bg); /* Dark mode card background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .form-section h2, .form-section h3 {
            margin-bottom: 15px; /* Space below section titles */
            color: var(--primary); /* Primary color for titles */
            font-weight: 600; /* Semi-bold */
            font-size: 1.3rem; /* Larger font for section titles */
        }

        body.dark-mode .form-section h2,
        body.dark-mode .form-section h3 {
            color: var(--dark-mode-primary); /* Dark mode primary color for titles */
        }

        .form-group {
            margin-bottom: 15px; /* Space between form groups */
        }

        .form-group label {
            display: block; /* Label on its own line */
            margin-bottom: 8px;
            font-weight: 500; /* Medium font weight */
            color: var(--text); /* Default text color */
        }

        body.dark-mode .form-group label {
            color: var(--dark-mode-text); /* Dark mode text */
        }

        /* Input and select styling */
        input[type="text"],
        input[type="password"],
        input[type="datetime-local"],
        input[type="date"],
        select,
        textarea {
            width: 100%; /* Full width */
            padding: 12px; /* Padding inside inputs */
            border: 1px solid var(--input-border-color); /* Default border color */
            border-radius: var(--border-radius-default); /* Rounded corners */
            font-size: 1rem; /* Standard font size */
            transition: border-color var(--transition-fast); /* Smooth border transition on focus */
            color: var(--text); /* Input text color */
            background-color: var(--card-background); /* White background */
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="datetime-local"],
        body.dark-mode input[type="date"],
        body.dark-mode select,
        body.dark-mode textarea {
            border-color: var(--dark-mode-border-color); /* Dark mode border color */
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            color: var(--dark-mode-text); /* Dark mode text */
        }

        input:focus, select:focus, textarea:focus {
            outline: none; /* Remove default outline */
            border-color: var(--input-focus-border-color); /* Highlight with primary color */
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: var(--dark-mode-input-focus-border-color); /* Dark mode focus border */
        }

        select {
            appearance: none; /* Remove default browser styling */
            /* Add custom dropdown arrow */
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%236c757d"><path d="M7.293 10.293a1 1 0 0 1 1.414 0L10.5 12.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-3.5 3.5a1 1 0 0 1-1.414 0l-3.5-3.5a1 1 0 0 1 0-1.414z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px top 50%; /* Position arrow */
            background-size: 16px; /* Size of the arrow */
            padding-right: 35px; /* Space for the arrow */
        }

        body.dark-mode select {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23e0e0e0"><path d="M7.293 10.293a1 1 0 0 1 1.414 0L10.5 12.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-3.5 3.5a1 1 0 0 1-1.414 0l-3.5-3.5a1 1 0 0 1 0-1.414z"/></svg>'); /* Dark mode arrow */
        }

        /* Handle 'Other' inputs for select fields */
        .form-group input[type="text"][style*="display: block;"] {
            margin-top: 10px; /* Add margin if it's displayed */
        }

        /* Button styling */
        button {
            background-color: var(--primary); /* Primary button color */
            color: white; /* White text */
            border: none; /* No border */
            padding: 12px 20px; /* Padding */
            border-radius: var(--border-radius-default); /* Rounded corners */
            cursor: pointer; /* Indicate clickable */
            font-size: 1rem; /* Standard font size */
            font-weight: 500; /* Medium weight */
            transition: background-color var(--transition-fast); /* Smooth hover effect */
            display: inline-flex; /* Align items nicely */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
            width: 100%; /* Full width by default */
            margin-bottom: 10px; /* Space below button */
        }

        body.dark-mode button {
            background-color: var(--dark-mode-primary); /* Dark mode primary color */
        }

        button:active {
            background-color: var(--button-hover-bg); /* Darker color on press */
        }

        body.dark-mode button:active {
            background-color: var(--dark-mode-button-hover-bg); /* Dark mode active color */
        }

        button.secondary {
            background-color: white; /* White background */
            color: var(--primary); /* Primary text color */
            border: 1px solid var(--primary); /* Primary border */
        }

        body.dark-mode button.secondary {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            color: var(--dark-mode-primary); /* Dark mode primary text */
            border-color: var(--dark-mode-primary); /* Dark mode primary border */
        }

        button.secondary:active {
            background-color: var(--light-gray); /* Light gray on press */
        }

        body.dark-mode button.secondary:active {
            background-color: var(--dark-mode-secondary); /* Dark mode secondary hover */
        }


        button.danger {
            background-color: var(--danger); /* Danger color */
        }

        button.danger:active {
            background-color: #c82333; /* Darker danger red on press */
        }

        .button-group {
            display: flex;
            flex-direction: column; /* Stack buttons vertically by default */
            gap: 10px; /* Space between buttons */
            margin-top: 15px; /* Space above the group */
        }

        /* --- Transaction List Styles --- */
        .transaction-list {
            margin-top: 15px; /* Space above the list */
        }

        .transaction-list h2, .summary-section h2 {
            margin-bottom: 10px; /* Space below section titles */
            color: var(--primary); /* Primary color for titles */
            font-weight: 600; /* Semi-bold */
            cursor: pointer; /* Indicate clickable */
            display: flex; /* Use flexbox for alignment */
            justify-content: space-between; /* Space out title and arrow */
            align-items: center; /* Vertically align items */
            padding: 12px 15px; /* Padding */
            background-color: var(--card-background); /* White background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            border: 1px solid var(--medium-gray); /* Light gray border */
            font-size: 1.1rem; /* Larger font size */
        }

        body.dark-mode .transaction-list h2,
        body.dark-mode .summary-section h2 {
            color: var(--dark-mode-primary); /* Dark mode primary color */
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .transaction-list h2 .arrow, .summary-section h2 .arrow {
            transition: transform var(--transition-fast); /* Smooth rotation for arrow */
            font-size: 0.9rem; /* Smaller font size for arrow */
        }

        .transaction-list.expanded h2 .arrow, .summary-section.expanded h2 .arrow {
            transform: rotate(180deg); /* Rotate arrow when expanded */
        }

        .transaction-list-items, .summary-list {
            display: none; /* Hide content by default */
            margin-top: 10px; /* Space above content */
        }

        .transaction-list.expanded .transaction-list-items, .summary-section.expanded .summary-list {
            display: block; /* Show content when expanded */
        }

        .grouped-transaction {
            margin-bottom: 15px; /* Space between date groups */
            background-color: var(--card-background); /* White background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            overflow: hidden; /* Hide overflow content */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .grouped-transaction {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .group-header {
            background-color: var(--light-gray); /* Light gray background */
            padding: 12px 15px; /* Padding */
            display: flex;
            justify-content: space-between; /* Space out date and summary */
            align-items: center;
            cursor: pointer; /* Indicate clickable */
            font-weight: 500; /* Medium font weight */
            border-left: 4px solid var(--primary); /* Primary accent on the left */
            font-size: 0.9rem; /* Small font size */
        }

        body.dark-mode .group-header {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-left-color: var(--dark-mode-primary); /* Dark mode accent */
            color: var(--dark-mode-text); /* Dark mode text */
        }

        .group-header span:last-child {
            font-size: 0.8rem; /* Smaller font for summary text */
            color: var(--dark-gray); /* Dark gray color */
        }

        body.dark-mode .group-header span:last-child {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
        }

        .transaction-item {
            background-color: var(--card-background); /* White background */
            padding: 12px 15px; /* Padding */
            margin: 0 0 10px 0; /* Margin below each item */
            border-radius: var(--border-radius-default); /* Rounded corners */
            position: relative; /* For positioning actions */
            border-left: 4px solid var(--primary); /* Primary accent */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .transaction-item {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
            border-left-color: var(--dark-mode-primary); /* Dark mode accent */
        }

        .transaction-item:last-child {
            margin-bottom: 0; /* No bottom margin for the last item */
        }

        .transaction-header {
            display: flex;
            justify-content: space-between; /* Space out type and amount */
            margin-bottom: 8px;
            align-items: center;
        }

        .transaction-type {
            font-weight: 500; /* Medium font weight */
            color: var(--primary); /* Primary color */
            font-size: 0.9rem; /* Small font size */
        }

        body.dark-mode .transaction-type {
            color: var(--dark-mode-primary); /* Dark mode primary color */
        }

        .transaction-amount {
            font-weight: 600; /* Semi-bold */
            font-size: 1rem; /* Standard font size */
        }

        .transaction-amount.positive { color: var(--positive); } /* Green for positive */
        .transaction-amount.negative { color: var(--negative); } /* Red for negative */

        .transaction-details-mobile {
            font-size: 0.8rem; /* Small font size */
            color: var(--dark-gray); /* Dark gray text */
            display: flex;
            flex-direction: column; /* Stack details vertically */
            gap: 4px; /* Spacing between detail lines */
        }

        body.dark-mode .transaction-details-mobile {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
        }

        .transaction-info-line {
            display: flex;
            gap: 10px; /* Spacing between info items */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .transaction-info-line span {
            white-space: nowrap; /* Prevent wrapping within a detail */
        }

        .transaction-info-item {
            display: inline; /* Display as inline elements */
        }

        .transaction-actions {
            display: flex; /* Arrange buttons horizontally */
            justify-content: flex-end; /* Align to the right */
            gap: 8px; /* Spacing between buttons */
            margin-top: 10px; /* Space above buttons */
        }

        .action-button-text {
            padding: 6px 10px; /* Padding for buttons */
            border-radius: var(--border-radius-default); /* Rounded corners */
            font-weight: 500; /* Medium weight */
            font-size: 0.8rem; /* Small font size */
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 5px; /* Space between icon and text */
            text-decoration: none; /* Remove underline for text buttons */
            border: none; /* Remove default button border */
            cursor: pointer; /* Indicate clickable */
        }

        .action-button-text.edit {
            background-color: var(--primary); /* Primary color */
            color: white; /* White text */
        }

        body.dark-mode .action-button-text.edit {
            background-color: var(--dark-mode-primary); /* Dark mode primary */
        }

        .action-button-text.delete {
            background-color: var(--danger); /* Danger color */
            color: white; /* White text */
        }

        /* --- Summary Section --- */
        .summary-section {
            background: var(--card-background); /* White background */
            padding: 15px;
            border-radius: var(--border-radius-default); /* Rounded corners */
            margin-top: 15px; /* Space above section */
            box-shadow: var(--shadow-sm); /* Small shadow */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .summary-section {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .summary-list {
            display: none; /* Hide content by default */
            margin-top: 10px; /* Space above list */
        }

        .summary-section.expanded .summary-list {
            display: block; /* Show content when expanded */
        }

        .summary-item {
            display: flex; /* Use flexbox for alignment */
            justify-content: space-between; /* Space out label and value */
            padding: 10px 0; /* Padding */
            border-bottom: 1px solid var(--medium-gray); /* Light gray divider */
            font-size: 0.9rem; /* Small font size */
        }

        body.dark-mode .summary-item {
            border-bottom-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .summary-item:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .summary-label {
            font-weight: 500; /* Medium font weight */
            color: var(--dark-gray); /* Dark gray text */
        }

        body.dark-mode .summary-label {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
        }

        /* --- Filter Section --- */
        .filter-section {
            display: flex; /* Use flexbox for filter controls */
            flex-direction: column; /* Stack controls vertically by default */
            gap: 10px; /* Spacing between controls */
            margin-bottom: 15px; /* Space below filter section */
            padding: 15px;
            background-color: var(--card-background); /* White background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .filter-section {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .filter-section button {
            margin-bottom: 0; /* Remove default bottom margin from buttons in filter */
        }

        /* --- Input Field Enhancements --- */
        .phone-input {
            position: relative;
        }

        .phone-input input {
            padding-left: 12px; /* Default padding */
        }

        /* --- Backup Section --- */
        .backup-section {
            background: var(--card-background); /* White background */
            padding: 15px;
            border-radius: var(--border-radius-default); /* Rounded corners */
            margin-top: 15px; /* Space above section */
            box-shadow: var(--shadow-sm); /* Small shadow */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .backup-section {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .backup-textarea {
            width: 100%;
            min-height: 120px; /* Minimum height */
            padding: 12px;
            border: 1px solid var(--input-border-color); /* Default border */
            border-radius: var(--border-radius-default); /* Rounded corners */
            font-family: monospace; /* Monospaced font for code-like text */
            margin-bottom: 15px; /* Space below textarea */
            resize: vertical; /* Allow vertical resizing */
            font-size: 0.8rem; /* Small font size */
        }

        body.dark-mode .backup-textarea {
            border-color: var(--dark-mode-border-color); /* Dark mode border */
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            color: var(--dark-mode-text); /* Dark mode text */
        }

        /* --- Toast Notification --- */
        .toast {
            position: fixed; /* Fixed position */
            bottom: 20px; /* Position at the bottom */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%) translateY(50px); /* Start off-screen below */
            background-color: var(--primary); /* Default primary color */
            color: white; /* White text */
            padding: 12px 20px; /* Padding */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-md); /* Medium shadow */
            opacity: 0; /* Initially invisible */
            transition: opacity var(--transition-fast), transform var(--transition-fast); /* Smooth fade and slide effect */
            z-index: 1000; /* High z-index to be on top */
            font-size: 0.9rem; /* Small font size */
            font-weight: 500; /* Medium weight */
            display: flex; /* Align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
            pointer-events: none; /* Not interactive */
            max-width: 90%; /* Limit width */
            text-align: center; /* Center text */
        }

        body.dark-mode .toast {
            background-color: var(--dark-mode-primary); /* Dark mode toast background */
            color: var(--dark-mode-text); /* Dark mode toast text */
        }

        .toast.show {
            opacity: 1; /* Make visible */
            transform: translateX(-50%) translateY(0); /* Slide into view */
        }

        .toast.error {
            background-color: var(--danger); /* Red background for errors */
        }
        .toast.warning {
            background-color: #ffc107; /* Yellow for warnings */
            color: var(--text); /* Dark text for warnings */
        }
        body.dark-mode .toast.warning {
             color: var(--dark-mode-text); /* Dark mode text for warnings */
        }

        /* --- Export Buttons --- */
        .export-buttons-container {
            margin-top: 15px; /* Space above container */
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 10px; /* Spacing between buttons */
        }

        .export-button {
            background-color: var(--secondary); /* Use secondary color for export buttons */
            color: white; /* White text */
            padding: 12px 20px; /* Padding */
        }

        body.dark-mode .export-button {
            background-color: var(--dark-mode-secondary); /* Dark mode secondary color */
            color: var(--dark-mode-text); /* Dark mode text */
        }

        /* --- Message for No Data --- */
        .no-data {
            text-align: center; /* Center text */
            color: var(--dark-gray); /* Dark gray text */
            margin-top: 15px; /* Space above message */
            padding: 20px;
            font-size: 0.9rem; /* Small font size */
            opacity: 0.7; /* Slightly transparent */
            background-color: var(--light-gray); /* Light gray background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            border: 1px dashed var(--medium-gray); /* Dashed border */
        }

        body.dark-mode .no-data {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }


        /* --- Debt/Credit Tab Styles --- */
        .debt-list-item {
            background: var(--card-background); /* White background */
            padding: 15px;
            margin-bottom: 10px; /* Space below item */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-sm); /* Small shadow */
            position: relative;
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .debt-list-item {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .debt-item-summary {
            display: flex; /* Align items horizontally */
            justify-content: space-between; /* Space out name and amount */
            align-items: center; /* Vertically align */
            width: 100%; /* Full width */
            cursor: pointer; /* Indicate clickable */
            margin-bottom: 10px; /* Space below summary */
        }

        .debt-item-summary.sticky-header { /* Added for sticky header effect */
            position: sticky;
            top: 0; /* Stick to the top of its container */
            z-index: 10; /* Ensure it's above other content */
            background-color: var(--card-background); /* Maintain background */
            padding-top: 15px; /* Adjust padding if needed */
            padding-bottom: 10px; /* Adjust padding */
            margin-bottom: 10px; /* Maintain spacing */
        }

        body.dark-mode .debt-item-summary.sticky-header {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
        }

        .debt-item-summary .debt-name {
            font-weight: 600; /* Semi-bold */
            font-size: 1rem; /* Standard font size */
            color: var(--primary); /* Primary color */
        }

        body.dark-mode .debt-item-summary .debt-name {
            color: var(--dark-mode-primary); /* Dark mode primary color */
        }

        .debt-item-summary .debt-amount {
            font-size: 1.1rem; /* Larger font size */
            font-weight: 600; /* Semi-bold */
        }

        .debt-item-details-expanded {
            display: none; /* Hide details by default */
            flex-direction: column; /* Stack content vertically */
            gap: 10px; /* Spacing between detail elements */
            font-size: 0.9rem; /* Small font size */
            color: var(--dark-gray); /* Dark gray text */
            border-top: 1px solid var(--medium-gray); /* Top border divider */
            padding-top: 10px; /* Padding above details */
        }

        body.dark-mode .debt-item-details-expanded {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
            border-top-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .debt-item-details-expanded.visible {
            display: flex; /* Show details when visible */
        }

        .debt-actions {
            display: flex; /* Arrange actions horizontally */
            justify-content: flex-end; /* Align to the right */
            gap: 8px; /* Spacing between action buttons */
            margin-bottom: 10px; /* Space below actions */
        }

        .debt-details {
            display: flex; /* Arrange details horizontally */
            gap: 10px; /* Spacing between detail elements */
            margin-bottom: 10px; /* Space below details */
            align-items: center; /* Vertically align */
            flex-wrap: wrap; /* Allow wrapping */
        }

        .debt-type {
            font-weight: 500; /* Medium font weight */
            color: var(--text-light); /* Light text color */
            padding: 4px 8px; /* Padding */
            background-color: var(--light-gray); /* Light gray background */
            border-radius: var(--border-radius-default); /* Rounded corners */
            font-size: 0.8rem; /* Small font size */
        }

        body.dark-mode .debt-type {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
        }

        .debt-note {
            font-size: 0.8rem; /* Small font size */
            color: var(--text-light); /* Light text color */
        }

        body.dark-mode .debt-note {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
        }

        .debt-history-list {
            margin-top: 10px;
            padding-left: 10px; /* Indent history */
            border-left: 2px solid var(--medium-gray); /* Left border for history */
        }

        body.dark-mode .debt-history-list {
            border-left-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .debt-history-item {
            display: flex; /* Align items horizontally */
            justify-content: space-between; /* Space out text and actions */
            align-items: center;
            margin-bottom: 8px; /* Space below item */
            font-size: 0.8rem; /* Small font size */
            color: var(--dark-gray); /* Dark gray text */
            padding-bottom: 8px; /* Padding below text */
            border-bottom: 1px dashed var(--medium-gray); /* Dashed bottom border */
            flex-wrap: wrap; /* Allow wrapping for actions */
        }

        body.dark-mode .debt-history-item {
            color: var(--dark-mode-secondary); /* Dark mode secondary text */
            border-bottom-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .debt-history-item:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .debt-history-item .negative {
            color: var(--negative); /* Red for negative amounts */
        }
        .debt-history-item .positive {
            color: var(--positive); /* Green for positive amounts */
        }

        .debt-history-item .debt-history-actions {
             display: flex; /* Arrange buttons horizontally */
             gap: 6px; /* Spacing between buttons */
             margin-left: 8px; /* Space from the text */
             flex-shrink: 0; /* Prevent shrinking */
        }

        /* --- Debt Summary Totals --- */
        .debt-summary-totals {
            background-color: var(--light-gray); /* Light gray background */
            padding: 15px;
            margin-top: 15px; /* Space above totals */
            border-radius: var(--border-radius-default); /* Rounded corners */
            display: flex;
            flex-direction: column; /* Stack totals vertically */
            gap: 10px; /* Spacing between totals */
            font-weight: 600; /* Semi-bold */
            font-size: 1rem; /* Standard font size */
            border: 1px solid var(--medium-gray); /* Light gray border */
        }

        body.dark-mode .debt-summary-totals {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .debt-summary-totals .total-payable,
        .debt-summary-totals .total-receivable {
            display: flex; /* Align label and amount */
            justify-content: space-between; /* Space them out */
            align-items: center;
        }

        .debt-summary-totals .total-payable .amount {
            color: var(--negative); /* Red for payable amount */
        }

        .debt-summary-totals .total-receivable .amount {
            color: var(--positive); /* Green for receivable amount */
        }

        /* --- Debt Name Suggestions --- */
        #debt-name-suggestions {
            position: absolute; /* Position relative to parent */
            width: calc(100% - 30px); /* Full width minus container padding */
            background-color: white; /* White background */
            border: 1px solid var(--medium-gray); /* Light gray border */
            border-radius: var(--border-radius-default); /* Rounded corners */
            box-shadow: var(--shadow-md); /* Medium shadow */
            z-index: 50; /* Ensure it's above other elements */
            display: none; /* Hidden by default */
            max-height: 200px; /* Limit height */
            overflow-y: auto; /* Add scrollbar if content exceeds height */
        }

        body.dark-mode #debt-name-suggestions {
            background-color: var(--dark-mode-card-bg); /* Dark mode background */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
            box-shadow: var(--shadow-md); /* Ensure shadow is visible on dark background */
        }

        .debt-suggestion-item {
            padding: 10px 15px; /* Padding */
            cursor: pointer; /* Indicate clickable */
            transition: background-color var(--transition-fast); /* Smooth hover effect */
            font-size: 0.9rem; /* Small font size */
        }
        .debt-suggestion-item:hover {
            background-color: var(--light-gray); /* Light gray on hover */
        }

        body.dark-mode .debt-suggestion-item:hover {
            background-color: var(--dark-mode-secondary); /* Dark mode hover */
        }


        /* --- Responsive Adjustments --- */
        @media (min-width: 768px) {
            .container {
                max-width: 750px; /* Max width for larger screens */
                padding: 20px;
                margin: 20px auto; /* Center container with margin */
            }

            /* Tab layout adjustments for larger screens */
            .tabs-container, .tabs-container-bottom {
                display: flex; /* Use flexbox for tab layout */
                justify-content: center; /* Center tabs */
                flex-wrap: wrap; /* Allow tabs to wrap if needed */
            }

            .tab {
                padding: 12px 15px; /* Larger padding */
                flex: 0 0 auto; /* Prevent flex shrinking/growing */
            }

            /* Card layout adjustments */
            .card-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Wider minimum card width */
            }

            /* Filter section layout */
            .filter-section {
                flex-direction: row; /* Arrange filters horizontally */
                flex-wrap: wrap; /* Allow wrapping */
                align-items: center; /* Align items vertically */
            }

            .filter-section select,
            .filter-section input {
                flex: 1; /* Allow filters to grow */
                min-width: 150px; /* Minimum width for filters */
            }

            .filter-section button {
                width: auto; /* Auto width for buttons */
                flex-shrink: 0; /* Prevent shrinking */
            }

            /* Button group layout */
            .button-group {
                flex-direction: row; /* Arrange buttons horizontally */
            }

            .button-group button {
                width: auto; /* Auto width */
                flex: 1; /* Allow buttons to share space */
            }
        }

        /* --- Animation for smoother transitions --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out; /* Apply fade-in animation to tab content */
        }

        /* --- Toast Notification Color Adjustments --- */
        .toast.success {
            background-color: var(--positive); /* Green for success */
        }
        body.dark-mode .toast.success {
            background-color: var(--positive); /* Keep positive color for success */
        }

        /* --- Appearance Section in Opening Tab --- */
        #settings-appearance-section {
            margin-top: 20px; /* Space above this section */
        }
        #settings-appearance-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.3rem;
        }
        body.dark-mode #settings-appearance-section h3 {
            color: var(--dark-mode-primary);
        }

        #appearance-dark-mode-button {
            background-color: var(--light-gray); /* Light gray for the button */
            color: var(--dark-gray); /* Dark gray text */
            border: 1px solid var(--medium-gray); /* Subtle border */
            padding: 12px 20px;
            border-radius: var(--border-radius-default);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color var(--transition-fast), color var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: auto; /* Auto width for this button */
            margin-bottom: 0; /* No bottom margin */
        }

        #appearance-dark-mode-button:hover {
            background-color: var(--medium-gray);
            color: var(--primary);
        }

        .dark-mode #appearance-dark-mode-button {
            background-color: var(--dark-mode-card-bg); /* Dark mode button background */
            color: var(--dark-mode-text); /* Dark mode text */
            border-color: var(--dark-mode-border-color); /* Dark mode border */
        }

        .dark-mode #appearance-dark-mode-button:hover {
            background-color: var(--dark-mode-secondary); /* Dark mode hover */
            color: var(--dark-mode-primary); /* Dark mode hover text */
        }

        .dark-mode #appearance-dark-mode-button i {
            color: var(--dark-mode-primary); /* Ensure icon is visible in dark mode */
        }

    </style>
</head>
<body>

    <!-- Lock Screen Overlay -->
    <div id="lock-screen-overlay">
        <div id="lock-screen-content">
            <div id="lock-screen-title">Money Manager</div>
            <div id="lock-screen-message">Your application has been locked due to inactivity.</div>
            <input type="password" id="lock-screen-pin-input" maxlength="4" readonly placeholder="----">
            <div id="lock-screen-error-message"></div>
            <div id="lock-screen-keyboard">
                <div class="key-row">
                    <button onclick="handleLockScreenInput('1')">1</button>
                    <button onclick="handleLockScreenInput('2')">2</button>
                    <button onclick="handleLockScreenInput('3')">3</button>
                </div>
                <div class="key-row">
                    <button onclick="handleLockScreenInput('4')">4</button>
                    <button onclick="handleLockScreenInput('5')">5</button>
                    <button onclick="handleLockScreenInput('6')">6</button>
                </div>
                <div class="key-row">
                    <button onclick="handleLockScreenInput('7')">7</button>
                    <button onclick="handleLockScreenInput('8')">8</button>
                    <button onclick="handleLockScreenInput('9')">9</button>
                </div>
                <div class="key-row">
                    <button onclick="handleLockScreenInput('0')">0</button>
                </div>
                <div class="key-row">
                    <button onclick="handleLockScreenInput('delete')" class="key-delete"><i class="fas fa-backspace"></i></button>
                </div>
            </div>
            <div id="lock-screen-footer">MKT Computer & Mobile Services</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>My Money Manager</h1>
            <p>Your trusted companion for seamless financial tracking</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs-container">
            <div class="tab" onclick="switchTab('opening')">Opening</div>
            <div class="tab" onclick="switchTab('transaction')">Transactions</div>
            <div class="tab" onclick="switchTab('daily-money')">Daily Money</div>
        </div>

        <div class="tabs-container-bottom">
            <div class="tab" onclick="switchTab('expense')">Expenses</div>
            <div class="tab" onclick="switchTab('debt')">Debts/Credits</div>
        </div>

        <!-- Opening Tab Content -->
        <div id="opening" class="tab-content active"> <!-- Default active tab -->
            <div class="form-section">
                <h2>Set Opening Balances</h2>
                <div class="form-group">
                    <label for="opening-emoney">E-Money Balance</label>
                    <input type="text" id="opening-emoney" placeholder="Enter E-Money amount" oninput="formatInputAmount(this)">
                </div>
                <div class="form-group">
                    <label for="opening-cash">Cash Balance</label>
                    <input type="text" id="opening-cash" placeholder="Enter Cash amount" oninput="formatInputAmount(this)">
                </div>
                <button onclick="saveOpeningBalances()">Save Opening Balances</button>
            </div>

            <!-- Backup & Restore Section -->
            <div class="backup-section">
                <h2>Data Backup & Restore</h2>
                <textarea class="backup-textarea" id="backup-data" placeholder="Your backup data will appear here..."></textarea>

                <div class="button-group">
                    <button onclick="generateBackup()" class="secondary"><i class="fas fa-download"></i> Generate Backup</button>
                    <button onclick="restoreBackup()" class="secondary"><i class="fas fa-upload"></i> Restore</button>
                </div>

                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="generateBackupFile()" class="secondary"><i class="fas fa-file-export"></i> Export File</button>
                    <button class="secondary" onclick="document.getElementById('backup-file-input').click()"><i class="fas fa-file-import"></i> Import File</button>
                </div>

                <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="restoreFromFile(event)">
            </div>

            <!-- Export Data Section -->
            <div class="form-section">
                <h2>Export Your Data</h2>
                <div class="export-buttons-container">
                    <button class="export-button" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                    <button class="export-button" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                </div>
            </div>

            <!-- Security and Appearance Settings Section -->
            <div class="form-section">
                <div id="settings-lock-section">
                    <h3>Security Settings</h3>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="enable-screen-lock" onchange="saveLockSetting()" style="width: 18px; height: 18px;">
                            <label for="enable-screen-lock" style="margin-bottom: 0;">Enable Screen Lock</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="current-pin">Current PIN:</label>
                        <input type="password" id="current-pin" placeholder="Enter current PIN" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label for="new-pin">New PIN:</label>
                        <input type="password" id="new-pin" placeholder="Enter new 4-digit PIN" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-pin">Confirm New PIN:</label>
                        <input type="password" id="confirm-new-pin" placeholder="Confirm new PIN" maxlength="4">
                    </div>
                    <button onclick="handleChangePIN()">Change PIN</button>
                    <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-light);">
                        <i class="fas fa-info-circle"></i> Note: If you forget your PIN, all application data will be wiped.
                    </div>
                </div>

                <!-- Appearance Section -->
                <div id="settings-appearance-section">
                    <h3>Appearance</h3>
                    <button id="appearance-dark-mode-button" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i> Dark Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Transaction Tab Content -->
        <div id="transaction" class="tab-content">
            <div class="card-container">
                <div class="card">
                    <h3>E-Money Balance</h3>
                    <div class="card-amount" id="e-money-balance">0.00</div>
                </div>
                <div class="card">
                    <h3>Cash Balance</h3>
                    <div class="card-amount" id="cash-balance">0.00</div>
                </div>
                <div class="card">
                    <h3>Total Balance</h3>
                    <div class="card-amount" id="total-balance">0.00</div>
                </div>
            </div>

            <div class="form-section">
                <h2>Add New Transaction</h2>
                <div class="form-group">
                    <label for="transaction-id">Transaction ID</label>
                    <input type="text" id="transaction-id" placeholder="Enter unique transaction ID">
                </div>
                <div class="form-group">
                    <label for="transaction-date">Date/Time</label>
                    <input type="datetime-local" id="transaction-date">
                </div>
                <div class="form-group">
                    <label for="transaction-type">Transaction Type</label>
                    <select id="transaction-type" onchange="updateTransactionType(); updateSavedCommissionAndFee();">
                        <option value="Wave Money">Wave Money</option>
                        <option value="Wave Pay">Wave Pay</option>
                        <option value="KBZ Pay">KBZ Pay</option>
                        <option value="Aya Pay">Aya Pay</option>
                        <option value="other">Other (Manual)</option>
                    </select>
                    <input type="text" id="transaction-type-other" style="display: none; margin-top: 10px;" placeholder="Specify other type">
                </div>
                <div class="form-group">
                    <label for="transaction-action">Action</label>
                    <select id="transaction-action" onchange="updateSavedCommissionAndFee();">
                        <option value="Cash In">Cash In</option>
                        <option value="Cash Out">Cash Out</option>
                        <option value="Send Money">Send Money</option>
                        <option value="Received Money">Received Money</option>
                        <option value="Payment">Payment</option>
                        <option value="Phone Bill">Phone Bill</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-amount">Amount</label>
                    <input type="text" id="transaction-amount" placeholder="Enter amount" oninput="updateSavedCommissionAndFee(); formatInputAmount(this);">
                </div>
                <div class="form-group">
                    <label for="transaction-commission">Commission</label>
                    <input type="text" id="transaction-commission" placeholder="Commission" oninput="saveFeeTemporarily(); formatInputAmount(this);">
                </div>
                <div class="form-group">
                    <label for="transaction-fee">Fee</label>
                    <input type="text" id="transaction-fee" placeholder="Enter fee" oninput="saveFeeTemporarily(); formatInputAmount(this);">
                </div>
                <div class="form-group phone-input">
                    <label for="transaction-phone">Phone Number</label>
                    <input type="text" id="transaction-phone" placeholder="0912345678">
                </div>
                <div class="form-group">
                    <label for="transaction-note">Note</label>
                    <input type="text" id="transaction-note" placeholder="Optional: customer name, details">
                </div>
                <div class="button-group">
                    <button type="button" onclick="addTransaction()"><i class="fas fa-plus-circle"></i> Add Transaction</button>
                    <button onclick="clearTransactionForm()" class="secondary"><i class="fas fa-broom"></i> Clear Form</button>
                </div>
            </div>

            <!-- Transaction Filters -->
            <div class="filter-section">
                <select id="transaction-filter-type">
                    <option value="all">All Types</option>
                    <option value="Wave Money">Wave Money</option>
                    <option value="Wave Pay">Wave Pay</option>
                    <option value="KBZ Pay">KBZ Pay</option>
                    <option value="Aya Pay">Aya Pay</option>
                </select>
                <select id="transaction-filter-action">
                    <option value="all">All Actions</option>
                    <option value="Cash In">Cash In</option>
                    <option value="Cash Out">Cash Out</option>
                    <option value="Send Money">Send Money</option>
                    <option value="Received Money">Received Money</option>
                    <option value="Payment">Payment</option>
                    <option value="Phone Bill">Phone Bill</option>
                </select>
                <input type="date" id="transaction-filter-date" onchange="filterTransactions()">
                <button onclick="filterTransactions()"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="resetTransactionFilters()" class="secondary"><i class="fas fa-times"></i> Reset</button>
            </div>

            <!-- Transaction List -->
            <div class="transaction-list" id="transaction-list">
                <h2 onclick="toggleTransactionList()">Transaction History <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="transaction-list-items">
                    <!-- Transactions will be added here dynamically -->
                </div>
            </div>

            <!-- Daily Summary for Transactions -->
            <div class="summary-section">
                <h2 onclick="toggleTransactionSummary()">Daily Summary <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="summary-list">
                    <div class="summary-item">
                        <span class="summary-label">E-Money Balance (Today) [IN]:</span>
                        <span id="daily-e-money" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cash Balance (Today) [IN]:</span>
                        <span id="daily-cash" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Commission Earned (Today):</span>
                        <span id="total-commission-summary" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Fees Charged (Today):</span>
                        <span id="total-fee-summary" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                    	<span class="summary-label">Net Balance Change (Today):</span>
                        <span id="daily-net-balance" class="positive">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Money Tab Content -->
        <div id="daily-money" class="tab-content">
            <div class="form-section">
                <h2>Record Daily Money Flow</h2>
                <div class="form-group">
                    <label for="money-date">Date/Time</label>
                    <input type="datetime-local" id="money-date">
                </div>
                <div class="form-group">
                    <label for="money-amount">Amount</label>
                    <input type="text" id="money-amount" placeholder="Enter amount" oninput="calculateMoneyCommission(); formatInputAmount(this);">
                </div>
                <div class="form-group">
                    <label for="money-action">Action</label>
                    <select id="money-action" onchange="toggleCommissionField(); calculateMoneyCommission()">
                        <option value="Emoney In">E-Money In</option>
                        <option value="Emoney Out">E-Money Out</option>
                        <option value="Cash In">Cash In</option>
                        <option value="Cash Out">Cash Out</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="money-type">Type</label>
                    <select id="money-type" onchange="updateMoneyType()">
                        <option value="Wave Money">Wave Money</option>
                        <option value="KBZ Pay">KBZ Pay</option>
                        <option value="Aya Pay">Aya Pay</option>
                        <option value="other">Other (Manual)</option>
                    </select>
                    <input type="text" id="money-type-other" style="display: none; margin-top: 10px;" placeholder="Specify other type">
                </div>
                <div class="form-group" id="money-commission-group" style="display: none;">
                    <label for="money-commission">Commission (%)</label>
                    <input type="text" id="money-commission" placeholder="Enter commission percentage" oninput="calculateMoneyCommission(); formatInputAmount(this);">
                </div>
                <div class="form-group">
                    <label for="money-note">Note</label>
                    <input type="text" id="money-note" placeholder="Optional: source of funds, purpose">
                </div>
                <div class="button-group">
                    <button onclick="addMoneyRecord()"><i class="fas fa-plus-circle"></i> Add Record</button>
                    <button onclick="clearMoneyForm()" class="secondary"><i class="fas fa-broom"></i> Clear Form</button>
                </div>
            </div>

            <!-- Money Record Filters -->
            <div class="filter-section">
                <select id="money-filter-action">
                    <option value="all">All Actions</option>
                    <option value="Emoney In">E-Money In</option>
                    <option value="Emoney Out">E-Money Out</option>
                    <option value="Cash In">Cash In</option>
                    <option value="Cash Out">Cash Out</option>
                </select>
                <input type="date" id="money-filter-date" onchange="filterMoneyRecords()">
                <button onclick="filterMoneyRecords()"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="resetMoneyFilters()" class="secondary"><i class="fas fa-times"></i> Reset</button>
            </div>

            <!-- Money Records List -->
            <div class="transaction-list" id="money-list">
                <h2 onclick="toggleMoneyList()">Money Records Flow <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="transaction-list-items">
                    <!-- Records will be added here dynamically -->
                </div>
            </div>

            <!-- Daily Summary for Money Records -->
            <div class="summary-section">
                <h2 onclick="toggleDailyMoneySummary()">Daily Summary <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="summary-list">
                    <div class="summary-item">
                        <span class="summary-label">E-Money In:</span>
                        <span id="daily-emoney-in" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">E-Money Out:</span>
                        <span id="daily-emoney-out" class="negative">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cash In:</span>
                        <span id="daily-cash-in" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cash Out:</span>
                        <span id="daily-cash-out" class="negative">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Net Balance (Today):</span>
                        <span id="daily-remaining" class="positive">0.00</span>
                    </div>
                    <div class="summary-item" id="daily-money-commission-item" style="display: none;">
                        <span class="summary-label">Commission Earned:</span>
                        <span id="daily-money-commission" class="positive">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPENSE TAB Content -->
        <div id="expense" class="tab-content">
            <div class="form-section">
                <h2>Add New Expense/Income Entry</h2>
                <div class="form-group">
                    <label for="expense-date">Date/Time</label>
                    <input type="datetime-local" id="expense-date">
                </div>
                <div class="form-group">
                    <label for="expense-type">Type</label>
                    <select id="expense-type" onchange="updateExpenseCategoryVisibility()">
                        <option value="Expense">Expense</option>
                        <option value="Income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category" onchange="updateExpenseCategoryVisibility()">
                        <option value="Rent">Rent</option>
                        <option value="Sales">Sales</option>
                        <option value="other">Other (Manual)</option>
                    </select>
                    <input type="text" id="expense-category-other" style="display: none; margin-top: 10px;" placeholder="Specify other category">
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount</label>
                    <input type="text" id="expense-amount" placeholder="Enter amount" oninput="formatInputAmount(this)">
                </div>
                <div class="form-group">
                    <label for="expense-payment-method">Payment Method</label>
                    <select id="expense-payment-method" onchange="updatePaymentMethodVisibility()">
                        <option value="E-Money">E-Money</option>
                        <option value="Cash">Cash</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="expense-payment-method-other" style="display: none; margin-top: 10px;" placeholder="Specify other method">
                </div>
                <div class="form-group">
                    <label for="expense-note">Note</label>
                    <input type="text" id="expense-note" placeholder="Optional: purpose of expense, source of income">
                </div>
                <div class="button-group">
                    <button type="button" onclick="addExpenseEntry()"><i class="fas fa-plus-circle"></i> Add Entry</button>
                    <button onclick="clearExpenseForm()" class="secondary"><i class="fas fa-broom"></i> Clear Form</button>
                </div>
            </div>

            <!-- Expense Filters -->
            <div class="filter-section">
                <select id="expense-filter-type">
                    <option value="all">All Types</option>
                    <option value="Expense">Expense</option>
                    <option value="Income">Income</option>
                </select>
                <input type="text" id="expense-filter-category" placeholder="Filter by Category">
                <input type="date" id="expense-filter-date" onchange="filterExpenses()">
                <button onclick="filterExpenses()"><i class="fas fa-filter"></i> Filter</button>
                <button onclick="resetExpenseFilters()" class="secondary"><i class="fas fa-times"></i> Reset</button>
            </div>

            <!-- Expense/Income List -->
            <div class="transaction-list" id="expense-list">
                <h2 onclick="toggleExpand(this.parentElement)">Expense/Income Records <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="transaction-list-items">
                    <!-- Expense entries will be added here -->
                </div>
            </div>

            <!-- Daily Summary for Expenses -->
            <div class="summary-section">
                <h2 onclick="updateExpenseSummaries(); toggleExpand(this.parentElement)">Daily Summary <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="summary-list">
                    <div class="summary-item">
                        <span class="summary-label">Total Income (Today):</span>
                        <span id="daily-total-income" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Expenses (Today):</span>
                        <span id="daily-total-expenses" class="negative">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Net Balance (Today):</span>
                        <span id="daily-net-balance" class="positive">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Periodical Summary for Expenses -->
            <div class="summary-section">
                <h2 onclick="updatePeriodicalExpenseSummaries(); toggleExpand(this.parentElement)">Periodical Summaries <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="summary-list">
                    <div class="form-group">
                        <label for="period-type">Select Period:</label>
                        <select id="period-type" onchange="updatePeriodicalExpenseSummaries()">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Income (Period):</span>
                        <span id="periodical-total-income" class="positive">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Expenses (Period):</span>
                        <span id="periodical-total-expenses" class="negative">0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Net Balance (Period):</span>
                        <span id="periodical-net-balance" class="positive">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debt/Credit Tab Content -->
        <div id="debt" class="tab-content">
            <div class="form-section debt-form-section">
                <h2>Add New Debt/Credit Entry</h2>
                <div class="form-group" style="position: relative;">
                    <label for="debt-name">Name</label>
                    <input type="text" id="debt-name" placeholder="Enter person's name" oninput="handleDebtNameInput(event)">
                    <!-- Suggestions Dropdown -->
                    <div id="debt-name-suggestions">
                        <!-- Suggestions will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="debt-type">Type</label>
                    <select id="debt-type" onchange="updateDebtFormVisibility()">
                        <option value="payable">You Owe (Payable)</option>
                        <option value="receivable">Others Owe You (Receivable)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="debt-amount">Amount</label>
                    <input type="text" id="debt-amount" placeholder="Enter amount" oninput="formatInputAmount(this)">
                </div>
                <div class="form-group">
                    <label for="debt-date">Date/Time</label>
                    <input type="datetime-local" id="debt-date">
                </div>
                <div class="form-group">
                    <label for="debt-note">Note</label>
                    <input type="text" id="debt-note" placeholder="Optional: reason for debt, repayment terms">
                </div>
                <div class="button-group">
                    <button id="add-update-debt-button" onclick="addOrUpdateDebtEntry()"><i class="fas fa-save"></i> Add Debt/Credit</button>
                    <button onclick="clearDebtForm()" class="secondary"><i class="fas fa-broom"></i> Clear Form</button>
                </div>
            </div>

            <!-- Debt Filter -->
            <div class="filter-section">
                <input type="text" id="debt-filter-name" placeholder="Search by Name..." style="min-width: 250px; flex-grow: 2;">
                <button onclick="filterDebts()"><i class="fas fa-search"></i> Search</button>
                <button onclick="resetDebtFilters()" class="secondary"><i class="fas fa-times"></i> Reset</button>
            </div>

            <!-- Payable Debts List -->
            <div class="transaction-list" id="payable-debts-list">
                <h2 onclick="toggleExpand(this.parentElement)">Payable Debts <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="transaction-list-items">
                    <!-- Payable debt items will be added here -->
                </div>
            </div>

            <!-- Receivable Credits List -->
            <div class="transaction-list" id="receivable-debts-list">
                <h2 onclick="toggleExpand(this.parentElement)">Receivable Credits <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
                <div class="transaction-list-items">
                    <!-- Receivable debt items will be added here -->
                </div>
            </div>

            <!-- Debt/Credit Summary Totals -->
            <div class="debt-summary-totals">
                <div class="total-payable">
                    <span class="label">Total Payable:</span>
                    <span class="amount" id="total-payable-amount">0.00</span>
                </div>
                <div class="total-receivable">
                    <span class="label">Total Receivable:</span>
                    <span class="amount" id="total-receivable-amount">0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Specific Script -->
    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/pwa-service-worker.js') // Path to your service worker file
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // --- GLOBAL STATE VARIABLES ---
        let transactions = [];
        let moneyRecords = [];
        let debts = [];
        let openingBalances = { eMoney: 0, cash: 0 };
        let savedOtherTransactionTypes = {};
        let savedOtherMoneyTypes = {};
        let tempCommissionData = {};
        let expenseEntries = [];
        let savedExpenseCategories = {};

        let existingDebtNames = [];
        let editingDebtEntry = null; // Context for debt entry being edited: { id, type, groupType, groupIdx, entryIdx }

        // --- SCREEN LOCK VARIABLES ---
        let isLocked = false;
        let lockAttempts = 0;
        const MAX_LOCK_ATTEMPTS = 10;
        let lockScreenTimer = null;
        const AUTO_LOCK_DELAY = 5 * 60 * 1000; // 5 minutes
        let pinInputBuffer = '';
        let settingsPIN = '0000'; // Default initial PIN
        let isScreenLockEnabled = false;
        let permanentlyLocked = false;
        let hideSuggestionsOnClickOutside = null; // Handler for closing debt name suggestions
        let currentFilteredTransactions = []; // To store transactions filtered by the UI
        let isDarkMode = false; // Dark mode state

        // --- INITIALIZATION FUNCTIONS ---

        // Initializes the lock screen state by loading settings from localStorage.
        function initializeLockScreen() {
            const storedPIN = localStorage.getItem('moneyManager_appPIN');
            settingsPIN = storedPIN ? storedPIN : '0000'; // Set stored PIN or default

            isScreenLockEnabled = localStorage.getItem('moneyManager_isScreenLockEnabled') === 'true';
            document.getElementById('enable-screen-lock').checked = isScreenLockEnabled;

            permanentlyLocked = localStorage.getItem('moneyManager_permanentlyLocked') === 'true';

            if (permanentlyLocked) {
                showLockScreen("This application has been permanently locked due to too many failed attempts. All data has been wiped.");
                document.getElementById('lock-screen-keyboard').style.display = 'none';
            } else if (isScreenLockEnabled && !isLocked) {
                showLockScreen("Your application has been locked. Please enter your PIN to continue.");
                lockAttempts = 0;
                pinInputBuffer = '';
            } else {
                hideLockScreen();
            }
        }

        // Saves the screen lock enable/disable setting to localStorage.
        function saveLockSetting() {
            isScreenLockEnabled = document.getElementById('enable-screen-lock').checked;
            localStorage.setItem('moneyManager_isScreenLockEnabled', isScreenLockEnabled);

            if (isScreenLockEnabled) {
                if (!isLocked && !permanentlyLocked) {
                    showLockScreen("Screen lock is now enabled. Please enter your PIN to continue.");
                    lockAttempts = 0; pinInputBuffer = '';
                }
            } else {
                if (isLocked) hideLockScreen();
                isLocked = false;
                clearTimeout(lockScreenTimer);
            }
        }

        // Displays the lock screen overlay with an optional message.
        function showLockScreen(message = null) {
            const overlay = document.getElementById('lock-screen-overlay');
            if (overlay) overlay.classList.add('visible');
            isLocked = true;
            pinInputBuffer = '';
            document.getElementById('lock-screen-pin-input').value = '';
            document.getElementById('lock-screen-error-message').textContent = '';
            document.getElementById('lock-screen-message').textContent = message || "Your application has been locked. Please enter your PIN.";
            document.getElementById('lock-screen-keyboard').style.display = permanentlyLocked ? 'none' : 'block';
        }

        // Hides the lock screen overlay and resumes application functionality.
        function hideLockScreen() {
            const overlay = document.getElementById('lock-screen-overlay');
            if (overlay) overlay.classList.remove('visible');
            isLocked = false;
            pinInputBuffer = '';
            document.getElementById('lock-screen-pin-input').value = '';
            document.getElementById('lock-screen-error-message').textContent = '';

            if (isScreenLockEnabled && !permanentlyLocked) startLockTimer();
        }

        // Handles input from the lock screen numeric keyboard (digits and delete).
        function handleLockScreenInput(input) {
            if (permanentlyLocked) return;

            if (input === 'delete') {
                pinInputBuffer = pinInputBuffer.slice(0, -1);
            } else {
                if (pinInputBuffer.length < 4) pinInputBuffer += input;
            }
            document.getElementById('lock-screen-pin-input').value = '*'.repeat(pinInputBuffer.length);

            if (pinInputBuffer.length === 4) checkPIN(pinInputBuffer);
        }

        // Checks the entered PIN against the stored settings PIN.
        function checkPIN(enteredPIN) {
            if (permanentlyLocked) return;

            if (enteredPIN === settingsPIN) {
                document.getElementById('lock-screen-error-message').textContent = '';
                hideLockScreen();
                return;
            } else {
                lockAttempts++;
                pinInputBuffer = '';
                document.getElementById('lock-screen-pin-input').value = '';

                if (lockAttempts >= MAX_LOCK_ATTEMPTS) {
                    permanentlyLocked = true;
                    localStorage.setItem('moneyManager_permanentlyLocked', 'true');
                    wipeAllData();
                    document.getElementById('lock-screen-message').textContent = "Your application has been permanently locked. All data has been wiped.";
                    document.getElementById('lock-screen-keyboard').style.display = 'none';
                    return;
                } else {
                    document.getElementById('lock-screen-error-message').textContent = `Incorrect PIN. ${MAX_LOCK_ATTEMPTS - lockAttempts} attempts remaining.`;
                    document.getElementById('lock-screen-message').textContent = "Incorrect PIN. Please try again.";
                }
            }
        }

        // Wipes all application data from localStorage and resets global state.
        function wipeAllData() {
            const keysToRemove = [
                'moneyManager_transactions', 'moneyManager_moneyRecords', 'moneyManager_openingBalances',
                'moneyManager_savedOtherTransactionTypes', 'moneyManager_savedOtherMoneyTypes',
                'moneyManager_tempCommissionData', 'moneyManager_debts', 'moneyManager_expenseEntries',
                'moneyManager_savedExpenseCategories', 'moneyManager_appPIN',
                'moneyManager_isScreenLockEnabled', 'moneyManager_permanentlyLocked', 'moneyManager_darkMode'
            ];
            keysToRemove.forEach(key => localStorage.removeItem(key));

            transactions = []; moneyRecords = []; debts = []; openingBalances = { eMoney: 0, cash: 0 };
            savedOtherTransactionTypes = {}; savedOtherMoneyTypes = {}; tempCommissionData = {};
            expenseEntries = []; savedExpenseCategories = {};
            isDarkMode = false; // Reset dark mode

            updateSummariesBasedOnCurrentView(); renderDebts(); populateCustomTypes();
            populateExpenseCategories(); renderExpenseEntries();
            document.getElementById('opening-emoney').value = ''; document.getElementById('opening-cash').value = '';
            document.body.classList.remove('dark-mode');

            showToast("All application data has been wiped due to security measures.", "error");
        }

        // Starts the timer for automatic screen locking after a period of inactivity.
        function startLockTimer() {
            clearTimeout(lockScreenTimer);
            lockScreenTimer = setTimeout(() => {
                if (!isLocked && isScreenLockEnabled && !permanentlyLocked) {
                    showLockScreen("Your session has timed out and the application has been locked.");
                    lockAttempts = 0; pinInputBuffer = '';
                }
            }, AUTO_LOCK_DELAY);
        }

        // Resets the inactivity timer when the user performs an action.
        function resetLockTimer() {
            if (!isLocked && isScreenLockEnabled && !permanentlyLocked) startLockTimer();
        }

        // --- SETTINGS: PIN CHANGE FUNCTIONALITY ---
        function handleChangePIN() {
            const currentPinInput = document.getElementById('current-pin');
            const newPinInput = document.getElementById('new-pin');
            const confirmNewPinInput = document.getElementById('confirm-new-pin');

            const currentPin = currentPinInput.value;
            const newPin = newPinInput.value;
            const confirmNewPin = confirmNewPinInput.value;

            if (!currentPin || !newPin || !confirmNewPin) {
                showToast("Please fill in all PIN fields.", "error"); return;
            }
            if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                showToast("New PIN must be exactly 4 digits.", "error"); return;
            }
            if (newPin !== confirmNewPin) {
                showToast("New PIN and Confirm New PIN do not match.", "error"); return;
            }
            if (currentPin !== settingsPIN) {
                showToast("Incorrect current PIN.", "error"); return;
            }

            settingsPIN = newPin;
            localStorage.setItem('moneyManager_appPIN', settingsPIN);
            currentPinInput.value = ''; newPinInput.value = ''; confirmNewPinInput.value = '';

            showToast("PIN changed successfully!", "success");
        }

        // --- Appearance: Dark Mode Toggle ---
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('moneyManager_darkMode', isDarkMode);

            const darkModeButton = document.getElementById('appearance-dark-mode-button');
            if (darkModeButton) {
                const icon = darkModeButton.querySelector('i');
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    darkModeButton.textContent = ' Light Mode'; // Update button text
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    darkModeButton.textContent = ' Dark Mode'; // Update button text
                }
            }
            showToast(isDarkMode ? "Dark mode enabled." : "Light mode enabled.");
        }

        function initializeDarkMode() {
            isDarkMode = localStorage.getItem('moneyManager_darkMode') === 'true';
            document.body.classList.toggle('dark-mode', isDarkMode);

            const darkModeButton = document.getElementById('appearance-dark-mode-button');
            if (darkModeButton) {
                const icon = darkModeButton.querySelector('i');
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    darkModeButton.textContent = ' Light Mode';
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    darkModeButton.textContent = ' Dark Mode';
                }
            }
        }

        // --- UTILITY FUNCTIONS ---

        // Formats a number for display with comma separators and two decimal places.
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            const n = parseFloat(num);
            if (isNaN(n)) return '0.00';

            if (Number.isInteger(n)) {
                return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            } else {
                let parts = n.toFixed(2).split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join('.');
            }
        }

        // Formats an input field value to have comma separators and at most two decimal places.
        function formatInputAmount(inputElement) {
            let value = inputElement.value.replace(/,/g, '');
            let cleanedValue = '';
            let decimalFound = false;

            for (let i = 0; i < value.length; i++) {
                const char = value[i];
                if (char >= '0' && char <= '9') {
                    cleanedValue += char;
                } else if (char === '.' && !decimalFound) {
                    cleanedValue += '.';
                    decimalFound = true;
                }
            }
            if (cleanedValue.includes('.')) {
                const decimalPart = cleanedValue.split('.')[1];
                if (decimalPart && decimalPart.length > 2) {
                    cleanedValue = cleanedValue.substring(0, cleanedValue.indexOf('.') + 3);
                }
            }

            let formattedValue = '';
            let commaIndex = cleanedValue.indexOf('.');
            let integerPart = commaIndex === -1 ? cleanedValue : cleanedValue.substring(0, commaIndex);
            let decimalPart = commaIndex === -1 ? '' : '.' + cleanedValue.substring(commaIndex + 1);

            for (let i = integerPart.length - 1; i >= 0; i--) {
                formattedValue = integerPart[i] + formattedValue;
                if ((integerPart.length - i) % 3 === 0 && i !== 0) {
                    formattedValue = ',' + formattedValue;
                }
            }
            inputElement.value = formattedValue + decimalPart;
        }

        // Sets the current date and time to relevant input fields if they are empty.
        function updateDateTimeFields() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');

            const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

            if (!document.getElementById('transaction-date').value) document.getElementById('transaction-date').value = currentDateTime;
            if (!document.getElementById('money-date').value) document.getElementById('money-date').value = currentDateTime;
            if (!document.getElementById('debt-date').value) document.getElementById('debt-date').value = currentDateTime;
            if (!document.getElementById('expense-date').value) document.getElementById('expense-date').value = currentDateTime;
        }

        // Displays a temporary notification message (toast) at the bottom of the screen.
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            void toast.offsetWidth; // Trigger reflow for transition
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300); // Match transition duration
            }, 3000);
        }

        // Adds a new option to a specified select element dynamically.
        function addOptionToSelect(selectId, optionValue) {
            const selectElement = document.getElementById(selectId);
            const optionExists = Array.from(selectElement.options).some(opt => opt.value.toLowerCase() === optionValue.toLowerCase());

            if (!optionExists && optionValue && optionValue.trim() !== '' && optionValue.trim().toLowerCase() !== 'other') {
                const newOption = document.createElement('option');
                newOption.value = optionValue.trim();
                newOption.textContent = optionValue.trim();

                const otherOption = selectElement.querySelector('option[value="other"]');
                if (otherOption) {
                    selectElement.insertBefore(newOption, otherOption);
                } else {
                    selectElement.appendChild(newOption);
                }
            }
        }

        // --- DATA PERSISTENCE (SAVE/LOAD TO LOCALSTORAGE) ---

        // Saves all application data to localStorage.
        function saveData() {
            try {
                localStorage.setItem('moneyManager_transactions', JSON.stringify(transactions));
                localStorage.setItem('moneyManager_moneyRecords', JSON.stringify(moneyRecords));
                localStorage.setItem('moneyManager_openingBalances', JSON.stringify(openingBalances));
                localStorage.setItem('moneyManager_savedOtherTransactionTypes', JSON.stringify(savedOtherTransactionTypes));
                localStorage.setItem('moneyManager_savedOtherMoneyTypes', JSON.stringify(savedOtherMoneyTypes));
                localStorage.setItem('moneyManager_tempCommissionData', JSON.stringify(tempCommissionData));
                localStorage.setItem('moneyManager_debts', JSON.stringify(debts));
                localStorage.setItem('moneyManager_expenseEntries', JSON.stringify(expenseEntries));
                localStorage.setItem('moneyManager_savedExpenseCategories', JSON.stringify(savedExpenseCategories));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                if (e.name === 'QuotaExceededError') showToast("Local storage is full. Cannot save data.", "error");
                else showToast("An error occurred while saving data.", "error");
            }
        }

        // Loads data from localStorage into the application's global variables.
        function loadData() {
            const savedTransactions = localStorage.getItem('moneyManager_transactions');
            const savedMoneyRecords = localStorage.getItem('moneyManager_moneyRecords');
            const savedOpeningBalances = localStorage.getItem('moneyManager_openingBalances');
            const savedOtherTransactionTypesData = localStorage.getItem('moneyManager_savedOtherTransactionTypes');
            const savedOtherMoneyTypesData = localStorage.getItem('moneyManager_savedOtherMoneyTypes');
            const savedTempCommissionData = localStorage.getItem('moneyManager_tempCommissionData');
            const savedDebts = localStorage.getItem('moneyManager_debts');
            const savedExpenseEntries = localStorage.getItem('moneyManager_expenseEntries');
            const savedExpenseCategoriesData = localStorage.getItem('moneyManager_savedExpenseCategories');

            try {
                transactions = savedTransactions ? JSON.parse(savedTransactions) : [];
                moneyRecords = savedMoneyRecords ? JSON.parse(savedMoneyRecords) : [];
                openingBalances = savedOpeningBalances ? JSON.parse(savedOpeningBalances) : { eMoney: 0, cash: 0 };
                savedOtherTransactionTypes = savedOtherTransactionTypesData ? JSON.parse(savedOtherTransactionTypesData) : {};
                savedOtherMoneyTypes = savedOtherMoneyTypesData ? JSON.parse(savedOtherMoneyTypesData) : {};
                tempCommissionData = savedTempCommissionData ? JSON.parse(savedTempCommissionData) : {};
                debts = savedDebts ? JSON.parse(savedDebts) : [];
                expenseEntries = savedExpenseEntries ? JSON.parse(savedExpenseEntries) : [];
                savedExpenseCategories = savedExpenseCategoriesData ? JSON.parse(savedExpenseCategoriesData) : {};

            } catch (e) {
                console.error("Error parsing data from localStorage:", e);
                showToast("Error reading data from local storage", "error");
                // Reset all data to defaults on error
                transactions = []; moneyRecords = []; debts = []; openingBalances = { eMoney: 0, cash: 0 };
                savedOtherTransactionTypes = {}; savedOtherMoneyTypes = {}; tempCommissionData = {};
                expenseEntries = []; savedExpenseCategories = {};
                return;
            }

            // Data validation and cleanup
            if (!Array.isArray(transactions)) transactions = [];
            if (!Array.isArray(moneyRecords)) moneyRecords = [];
            if (typeof openingBalances !== 'object' || openingBalances === null || isNaN(openingBalances.eMoney) || isNaN(openingBalances.cash)) openingBalances = { eMoney: 0, cash: 0 };
            if (typeof savedOtherTransactionTypes !== 'object' || savedOtherTransactionTypes === null) savedOtherTransactionTypes = {};
            if (typeof savedOtherMoneyTypes !== 'object' || savedOtherMoneyTypes === null) savedOtherMoneyTypes = {};
            if (typeof tempCommissionData !== 'object' || tempCommissionData === null) tempCommissionData = {};
            if (!Array.isArray(debts)) debts = [];
            if (!Array.isArray(expenseEntries)) expenseEntries = [];
            if (typeof savedExpenseCategories !== 'object' || savedExpenseCategories === null) savedExpenseCategories = {};

            updateExistingDebtNames();
            populateCustomTypes();
            populateExpenseCategories();
        }

        // Populates the custom transaction and money record type select dropdowns.
        function populateCustomTypes() {
            const transactionTypeSelect = document.getElementById('transaction-type');
            const moneyTypeSelect = document.getElementById('money-type');

            const existingTransactionTypes = Array.from(transactionTypeSelect.options).map(opt => opt.value.toLowerCase());
            for (const type in savedOtherTransactionTypes) {
                if (Object.hasOwnProperty.call(savedOtherTransactionTypes, type) && type.trim() !== '' && type.toLowerCase() !== 'other' && !existingTransactionTypes.includes(type.toLowerCase())) {
                    addOptionToSelect('transaction-type', type);
                }
            }

            const existingMoneyTypes = Array.from(moneyTypeSelect.options).map(opt => opt.value.toLowerCase());
            for (const type in savedOtherMoneyTypes) {
                if (Object.hasOwnProperty.call(savedOtherMoneyTypes, type) && type.trim() !== '' && type.toLowerCase() !== 'other' && !existingMoneyTypes.includes(type.toLowerCase())) {
                    addOptionToSelect('money-type', type);
                }
            }
        }

        // Populates the expense category select dropdown with saved custom categories.
        function populateExpenseCategories() {
            const expenseCategorySelect = document.getElementById('expense-category');
            const existingCategories = Array.from(expenseCategorySelect.options).map(opt => opt.value.toLowerCase());
            for (const category in savedExpenseCategories) {
                if (Object.hasOwnProperty.call(savedExpenseCategories, category) && category.trim() !== '' && category.toLowerCase() !== 'other' && !existingCategories.includes(category.toLowerCase())) {
                    addOptionToSelect('expense-category', category);
                }
            }
        }

        // --- MAIN APPLICATION INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode(); // Initialize dark mode first
            initializeLockScreen();
            updateDateTimeFields();
            loadData();

            updateSummariesBasedOnCurrentView();
            updateTransactionList(); updateMoneyList(); renderDebts(); renderExpenseEntries();
            updatePeriodicalExpenseSummaries();

            // Global click listener
            document.addEventListener('click', function(e) {
                // Handle active state for transaction items
                const transactionItem = e.target.closest('.transaction-item');
                if (transactionItem) {
                    if (!e.target.closest('.transaction-actions')) {
                        transactionItem.classList.toggle('active');
                        const parentGroupDetails = transactionItem.closest('.group-details');
                        if(parentGroupDetails) {
                            parentGroupDetails.querySelectorAll('.transaction-item').forEach(item => {
                                if (item !== transactionItem) item.classList.remove('active');
                            });
                        }
                    }
                } else {
                    document.querySelectorAll('.transaction-item').forEach(item => item.classList.remove('active'));
                }

                // Handle closing debt name suggestions
                const debtNameInput = document.getElementById('debt-name');
                const suggestionsContainer = document.getElementById('debt-name-suggestions');
                if (suggestionsContainer && debtNameInput && !suggestionsContainer.contains(e.target) && !debtNameInput.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                    if (hideSuggestionsOnClickOutside) {
                        document.removeEventListener('click', hideSuggestionsOnClickOutside);
                        hideSuggestionsOnClickOutside = null;
                    }
                }
                resetLockTimer(); // Reset lock timer on any click
            });

            // Event listeners for user activity to reset the lock timer
            document.addEventListener('mousemove', resetLockTimer);
            document.addEventListener('mousedown', resetLockTimer);
            document.addEventListener('keydown', resetLockTimer);
            document.addEventListener('touchstart', resetLockTimer);

            // Initial UI update for the default active tab
            switchTab('opening');

            // Ensure lock screen is displayed correctly on initial load if enabled
            if (isScreenLockEnabled && !permanentlyLocked) {
                showLockScreen("Your application has been locked. Please enter your PIN to continue.");
            } else {
                hideLockScreen();
            }
        });

        // --- TAB SWITCHING LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            updateSummariesBasedOnCurrentView();
            resetLockTimer();

            if (tabId === 'expense') updateExpenseTabUI();
        }

        // --- OPENING BALANCE TAB FUNCTIONS ---
        function saveOpeningBalances() {
            const eMoney = parseFloat(document.getElementById('opening-emoney').value.replace(/,/g, '')) || 0;
            const cash = parseFloat(document.getElementById('opening-cash').value.replace(/,/g, '')) || 0;

            openingBalances = { eMoney, cash };
            try {
                localStorage.setItem('moneyManager_openingBalances', JSON.stringify(openingBalances));
                showToast('Opening balances saved successfully!', 'success');
            } catch (e) {
                console.error("Error saving opening balances:", e);
                showToast('Error saving opening balances', 'error');
            }
            updateSummariesBasedOnCurrentView();
        }

        // --- BACKUP FUNCTIONS ---
        function generateBackup() {
            const backupData = {
                transactions: transactions, moneyRecords: moneyRecords, openingBalances: openingBalances,
                savedOtherTransactionTypes: savedOtherTransactionTypes, savedOtherMoneyTypes: savedOtherMoneyTypes,
                tempCommissionData: tempCommissionData, debts: debts, expenseEntries: expenseEntries,
                savedExpenseCategories: savedExpenseCategories, isScreenLockEnabled: isScreenLockEnabled,
                appPIN: settingsPIN, permanentlyLocked: permanentlyLocked, isDarkMode: isDarkMode
            };
            document.getElementById('backup-data').value = JSON.stringify(backupData, null, 2);
            showToast('Backup data generated!');
        }

        function restoreBackup() {
            if (!confirm('This action will merge your existing data with the data from the text area. Continue?')) return;

            try {
                const backupText = document.getElementById('backup-data').value;
                if (!backupText.trim()) { showToast('No backup data found in the text area', 'error'); return; }

                let backupData = JSON.parse(backupText);
                if (!backupData.transactions || !backupData.moneyRecords || !backupData.openingBalances || !backupData.debts || !backupData.expenseEntries || !backupData.savedExpenseCategories) {
                    showToast('Invalid backup data format (missing essential fields)', 'error'); return;
                }

                // Merge Data
                transactions = [...backupData.transactions.filter(bt => !transactions.some(at => at.id === bt.id)), ...transactions];
                moneyRecords = [...backupData.moneyRecords.filter(bmr => !moneyRecords.some(amr => amr.date === bmr.date && amr.amount === bmr.amount && amr.action === bmr.action)), ...moneyRecords];
                openingBalances = {
                    eMoney: parseFloat(backupData.openingBalances.eMoney) || openingBalances.eMoney,
                    cash: parseFloat(backupData.openingBalances.cash) || openingBalances.cash
                };
                if (isNaN(openingBalances.eMoney)) openingBalances.eMoney = 0; if (isNaN(openingBalances.cash)) openingBalances.cash = 0;

                savedOtherTransactionTypes = { ...backupData.savedOtherTransactionTypes, ...savedOtherTransactionTypes };
                savedOtherMoneyTypes = { ...backupData.savedOtherMoneyTypes, ...savedOtherMoneyTypes };
                tempCommissionData = { ...backupData.tempCommissionData, ...tempCommissionData };
                debts = [...backupData.debts.filter(bd => !debts.some(ad => ad.id === bd.id)), ...debts];
                expenseEntries = [...backupData.expenseEntries.filter(be => !expenseEntries.some(ae => ae.id === be.id)), ...expenseEntries];
                savedExpenseCategories = { ...backupData.savedExpenseCategories, ...savedExpenseCategories };

                // Restore security settings
                if (backupData.isScreenLockEnabled !== undefined) {
                    isScreenLockEnabled = backupData.isScreenLockEnabled;
                    localStorage.setItem('moneyManager_isScreenLockEnabled', isScreenLockEnabled);
                    document.getElementById('enable-screen-lock').checked = isScreenLockEnabled;
                }
                if (backupData.appPIN) { settingsPIN = backupData.appPIN; localStorage.setItem('moneyManager_appPIN', settingsPIN); }
                if (backupData.permanentlyLocked === true) {
                    permanentlyLocked = true; localStorage.setItem('moneyManager_permanentlyLocked', 'true');
                }

                // Restore appearance setting
                if (backupData.isDarkMode !== undefined) {
                    isDarkMode = backupData.isDarkMode;
                    localStorage.setItem('moneyManager_darkMode', isDarkMode);
                    document.body.classList.toggle('dark-mode', isDarkMode);
                    const darkModeButton = document.getElementById('appearance-dark-mode-button');
                    if (darkModeButton) {
                        const icon = darkModeButton.querySelector('i');
                        if (isDarkMode) {
                            icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                            darkModeButton.textContent = ' Light Mode';
                        } else {
                            icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                            darkModeButton.textContent = ' Dark Mode';
                        }
                    }
                }

                // Re-save all merged data
                saveData();
                updateSummariesBasedOnCurrentView(); updateTransactionList(); updateMoneyList();
                renderDebts(); populateCustomTypes(); populateExpenseCategories();
                renderExpenseEntries();
                document.getElementById('opening-emoney').value = formatNumber(openingBalances.eMoney);
                document.getElementById('opening-cash').value = formatNumber(openingBalances.cash);
                initializeLockScreen(); // Re-initialize lock screen

                showToast('Data merged successfully from text!', 'success');
            } catch (e) {
                console.error("Error restoring backup:", e);
                showToast('Invalid backup data format or error during restore', 'error');
            }
        }

        function generateBackupFile() {
            const backupData = {
                transactions: transactions, moneyRecords: moneyRecords, openingBalances: openingBalances,
                savedOtherTransactionTypes: savedOtherTransactionTypes, savedOtherMoneyTypes: savedOtherMoneyTypes,
                tempCommissionData: tempCommissionData, debts: debts, expenseEntries: expenseEntries,
                savedExpenseCategories: savedExpenseCategories, isScreenLockEnabled: isScreenLockEnabled,
                appPIN: settingsPIN, permanentlyLocked: permanentlyLocked, isDarkMode: isDarkMode
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `MoneyManager_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();

            URL.revokeObjectURL(url);
            link.remove();
            showToast('Backup file generated!');
        }

        function restoreFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')) {
                showToast('Invalid file type. Please select a .json file.', 'error');
                event.target.value = ''; return;
            }
            if (!confirm(`This action will merge your existing data with the data from "${file.name}". Continue?`)) {
                event.target.value = ''; return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData.transactions || !backupData.moneyRecords || !backupData.openingBalances || !backupData.debts || !backupData.expenseEntries || !backupData.savedExpenseCategories) {
                        showToast('Invalid backup file format (missing essential fields)', 'error'); return;
                    }

                    // Merge Data
                    transactions = [...backupData.transactions.filter(bt => !transactions.some(at => at.id === bt.id)), ...transactions];
                    moneyRecords = [...backupData.moneyRecords.filter(bmr => !moneyRecords.some(amr => amr.date === bmr.date && amr.amount === bmr.amount && amr.action === bmr.action)), ...moneyRecords];
                    openingBalances = {
                        eMoney: parseFloat(backupData.openingBalances.eMoney) || openingBalances.eMoney,
                        cash: parseFloat(backupData.openingBalances.cash) || openingBalances.cash
                    };
                    if (isNaN(openingBalances.eMoney)) openingBalances.eMoney = 0; if (isNaN(openingBalances.cash)) openingBalances.cash = 0;

                    savedOtherTransactionTypes = { ...backupData.savedOtherTransactionTypes, ...savedOtherTransactionTypes };
                    savedOtherMoneyTypes = { ...backupData.savedOtherMoneyTypes, ...savedOtherMoneyTypes };
                    tempCommissionData = { ...backupData.tempCommissionData, ...tempCommissionData };
                    debts = [...backupData.debts.filter(bd => !debts.some(ad => ad.id === bd.id)), ...debts];
                    expenseEntries = [...backupData.expenseEntries.filter(be => !expenseEntries.some(ae => ae.id === be.id)), ...expenseEntries];
                    savedExpenseCategories = { ...backupData.savedExpenseCategories, ...savedExpenseCategories };

                    // Restore security settings
                    if (backupData.isScreenLockEnabled !== undefined) {
                        isScreenLockEnabled = backupData.isScreenLockEnabled;
                        localStorage.setItem('moneyManager_isScreenLockEnabled', isScreenLockEnabled);
                        document.getElementById('enable-screen-lock').checked = isScreenLockEnabled;
                    }
                    if (backupData.appPIN) { settingsPIN = backupData.appPIN; localStorage.setItem('moneyManager_appPIN', settingsPIN); }
                    if (backupData.permanentlyLocked === true) {
                        permanentlyLocked = true; localStorage.setItem('moneyManager_permanentlyLocked', 'true');
                    }

                    // Restore appearance setting
                    if (backupData.isDarkMode !== undefined) {
                        isDarkMode = backupData.isDarkMode;
                        localStorage.setItem('moneyManager_darkMode', isDarkMode);
                        document.body.classList.toggle('dark-mode', isDarkMode);
                        const darkModeButton = document.getElementById('appearance-dark-mode-button');
                        if (darkModeButton) {
                            const icon = darkModeButton.querySelector('i');
                            if (isDarkMode) {
                                icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                                darkModeButton.textContent = ' Light Mode';
                            } else {
                                icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                                darkModeButton.textContent = ' Dark Mode';
                            }
                        }
                    }

                    saveData(); // Re-save all merged data
                    updateSummariesBasedOnCurrentView(); updateTransactionList(); updateMoneyList();
                    renderDebts(); populateCustomTypes(); populateExpenseCategories();
                    renderExpenseEntries();
                    document.getElementById('opening-emoney').value = formatNumber(openingBalances.eMoney);
                    document.getElementById('opening-cash').value = formatNumber(openingBalances.cash);
                    initializeLockScreen(); // Re-initialize lock screen

                    showToast('Data merged successfully from file!', 'success');
                } catch (e) {
                    console.error("Error parsing backup file:", e);
                    showToast('Error reading or parsing backup file', 'error');
                } finally {
                    event.target.value = ''; // Clear file input
                }
            };
            reader.onerror = function() {
                console.error("Error reading file:", reader.error);
                showToast('Error reading file', 'error');
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- TRANSACTION TAB FUNCTIONS ---
        function updateTransactionType() {
            const typeSelect = document.getElementById('transaction-type');
            const otherInput = document.getElementById('transaction-type-other');
            otherInput.style.display = typeSelect.value === 'other' ? 'block' : 'none';
            if (typeSelect.value === 'other') {
                if (otherInput.style.display === 'block' && document.activeElement !== otherInput) otherInput.focus();
            } else {
                otherInput.value = '';
            }
            updateSavedCommissionAndFee();
        }

        function updateSavedCommissionAndFee() {
            const type = document.getElementById('transaction-type').value;
            const typeOtherInput = document.getElementById('transaction-type-other');
            const typeOther = typeOtherInput.value.trim();
            const effectiveType = (type === 'other' && typeOther) ? typeOther : type;

            const action = document.getElementById('transaction-action').value;
            const amountStr = document.getElementById('transaction-amount').value.replace(/,/g, '');
            const amount = parseFloat(amountStr) || 0;

            const commissionInput = document.getElementById('transaction-commission');
            const feeInput = document.getElementById('transaction-fee');

            if (effectiveType && action && amount > 0) {
                const key = `${effectiveType}-${action}-${amount}`;
                const savedData = tempCommissionData[key];

                if (savedData) {
                    if (commissionInput.value === '' || parseFloat(commissionInput.value.replace(/,/g, '')) === 0) {
                        commissionInput.value = savedData.commission !== undefined && savedData.commission !== null ? formatNumber(savedData.commission) : '';
                    }
                    if (feeInput.value === '' || parseFloat(feeInput.value.replace(/,/g, '')) === 0) {
                         feeInput.value = savedData.fee !== undefined && savedData.fee !== null ? formatNumber(savedData.fee) : '';
                    }
                } else {
                    if (commissionInput.value === '') commissionInput.value = '';
                    if (feeInput.value === '') feeInput.value = '';
                }
            } else {
                if (commissionInput.value === '') commissionInput.value = '';
                if (feeInput.value === '') feeInput.value = '';
            }
        }

        function saveCommissionAndFee(type, action, amount, commission, fee) {
            if (type && action && !isNaN(amount) && amount > 0 && !isNaN(commission) && !isNaN(fee)) {
                const key = `${type}-${action}-${amount}`;
                if (!tempCommissionData[key] || tempCommissionData[key].commission !== commission || tempCommissionData[key].fee !== fee) {
                    tempCommissionData[key] = { commission, fee };
                    try { localStorage.setItem('moneyManager_tempCommissionData', JSON.stringify(tempCommissionData)); } catch (e) { console.error("Error saving tempCommissionData:", e); }
                }
            }
        }

        function saveFeeTemporarily() {
            const type = document.getElementById('transaction-type').value;
            const typeOtherInput = document.getElementById('transaction-type-other');
            const typeOther = typeOtherInput.value.trim();
            const effectiveType = (type === 'other' && typeOther) ? typeOther : type;

            const action = document.getElementById('transaction-action').value;
            const amountStr = document.getElementById('transaction-amount').value;
            const amount = parseFloat(amountStr.replace(/,/g, ''));

            const commissionStr = document.getElementById('transaction-commission').value;
            const commission = commissionStr ? parseFloat(commissionStr.replace(/,/g, '')) : 0;

            const feeStr = document.getElementById('transaction-fee').value;
            const fee = feeStr ? parseFloat(feeStr.replace(/,/g, '')) : 0;

            if (effectiveType && action && !isNaN(amount) && amount > 0 && !isNaN(commission) && !isNaN(fee)) {
                saveCommissionAndFee(effectiveType, action, amount, commission, fee);
            }
        }

        function addTransaction() {
            const id = document.getElementById('transaction-id').value.trim();
            const date = document.getElementById('transaction-date').value;
            let type = document.getElementById('transaction-type').value;
            const otherInput = document.getElementById('transaction-type-other');
            let finalType = type;

            if (type === 'other') {
                const customType = otherInput.value.trim();
                if (!customType) { showToast('Please specify the other transaction type', 'error'); return; }
                finalType = customType;
                if (!savedOtherTransactionTypes[finalType]) {
                    savedOtherTransactionTypes[finalType] = finalType;
                    try { localStorage.setItem('moneyManager_savedOtherTransactionTypes', JSON.stringify(savedOtherTransactionTypes)); } catch (e) { console.error("Error saving custom transaction type:", e); }
                    addOptionToSelect('transaction-type', finalType);
                }
            }

            const action = document.getElementById('transaction-action').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value.replace(/,/g, ''));
            const commission = document.getElementById('transaction-commission').value ? parseFloat(document.getElementById('transaction-commission').value.replace(/,/g, '')) : 0;
            const fee = document.getElementById('transaction-fee').value ? parseFloat(document.getElementById('transaction-fee').value.replace(/,/g, '')) : 0;
            let phone = document.getElementById('transaction-phone').value.trim();
            if (phone) phone = '09' + phone;
            const note = document.getElementById('transaction-note').value.trim();

            // Validation
            if (!id) { showToast('Transaction ID is required.', 'error'); return; }
            if (!date) { showToast('Date/Time is required.', 'error'); return; }
            if (!finalType) { showToast('Transaction Type is required.', 'error'); return; }
            if (!action) { showToast('Action is required.', 'error'); return; }
            if (isNaN(amount) || amount <= 0) { showToast('Amount must be a positive number.', 'error'); return; }
            if (isNaN(commission) || commission < 0) { showToast('Commission must be a non-negative number.', 'error'); return; }
            if (isNaN(fee) || fee < 0) { showToast('Fee must be a non-negative number.', 'error'); return; }
            if (transactions.some(t => t.id === id)) { showToast('Transaction ID already exists. Please use a unique ID.', 'error'); return; }

            const effectiveTypeForSave = (type === 'other' && otherInput.value.trim()) ? otherInput.value.trim() : type;
            saveCommissionAndFee(effectiveTypeForSave, action, amount, commission, fee);

            const transaction = { id, date, type: finalType, action, amount, commission, fee, phone, note };
            transactions.unshift(transaction); // Add to beginning

            try {
                localStorage.setItem('moneyManager_transactions', JSON.stringify(transactions));
                showToast('Transaction added successfully!', 'success');
            } catch (e) {
                console.error("Error saving transactions:", e);
                showToast('Error saving transaction', 'error');
            }

            updateSummariesBasedOnCurrentView(); updateTransactionList(); clearTransactionForm();
        }

        function clearTransactionForm() {
            document.getElementById('transaction-id').value = '';
            updateDateTimeFields();
            document.getElementById('transaction-type').value = 'Wave Money';
            document.getElementById('transaction-type-other').value = ''; document.getElementById('transaction-type-other').style.display = 'none';
            document.getElementById('transaction-action').value = 'Cash In';
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-commission').value = '';
            document.getElementById('transaction-fee').value = '';
            document.getElementById('transaction-phone').value = '';
            document.getElementById('transaction-note').value = '';
            updateSavedCommissionAndFee();
        }

        function updateTransactionTabBalances() {
            let currentEMoney = parseFloat(openingBalances.eMoney) || 0;
            let currentCash = parseFloat(openingBalances.cash) || 0;
            let totalCommission = 0; let totalFee = 0;

            transactions.forEach(t => {
                const amount = parseFloat(t.amount);
                const commission = parseFloat(t.commission) || 0;
                const fee = parseFloat(t.fee) || 0;

                totalCommission += commission; totalFee += fee;

                if (t.action === 'Cash In') { currentEMoney -= amount; currentCash += amount; }
                else if (t.action === 'Cash Out') { currentEMoney += amount; currentCash -= amount; }
                else if (['Send Money', 'Payment', 'Phone Bill'].includes(t.action)) {
                    currentEMoney -= amount; currentCash += amount;
                } else if (t.action === 'Received Money') {
                    currentEMoney += amount; currentCash -= amount;
                }
            });

            currentEMoney += totalCommission; currentCash += totalFee;

            document.getElementById('e-money-balance').textContent = formatNumber(currentEMoney);
            document.getElementById('cash-balance').textContent = formatNumber(currentCash);
            document.getElementById('total-balance').textContent = formatNumber(currentEMoney + currentCash);
        }

        function updateTransactionList(filteredTransactions = null) {
            const listContainer = document.querySelector('#transaction-list .transaction-list-items');
            const transactionsToShow = filteredTransactions !== null ? filteredTransactions : transactions;

            listContainer.innerHTML = '';
            if (transactionsToShow.length === 0) { listContainer.innerHTML += '<p class="no-data">No transactions found.</p>'; return; }

            const groupedTransactions = {};
            transactionsToShow.forEach((transaction) => {
                const originalIndex = transactions.findIndex(t => t.id === transaction.id && t.date === transaction.date);
                const dateKey = new Date(transaction.date).toISOString().split('T')[0];

                if (!groupedTransactions[dateKey]) {
                    groupedTransactions[dateKey] = {
                        items: [],
                        details: { emoneyChange: 0, cashChange: 0, totalCommission: 0, totalFee: 0 }
                    };
                }
                groupedTransactions[dateKey].items.push({ ...transaction, originalIndex: originalIndex });

                const amount = parseFloat(transaction.amount);
                const commission = parseFloat(transaction.commission);
                const fee = parseFloat(transaction.fee);

                if (transaction.action === 'Cash In') { groupedTransactions[dateKey].details.emoneyChange -= amount; groupedTransactions[dateKey].details.cashChange += amount; }
                else if (transaction.action === 'Cash Out') { groupedTransactions[dateKey].details.emoneyChange += amount; groupedTransactions[dateKey].details.cashChange -= amount; }
                else if (['Send Money', 'Payment', 'Phone Bill'].includes(transaction.action)) {
                    groupedTransactions[dateKey].details.emoneyChange -= amount; groupedTransactions[dateKey].details.cashChange += amount;
                } else if (transaction.action === 'Received Money') {
                    groupedTransactions[dateKey].details.emoneyChange += amount; groupedTransactions[dateKey].details.cashChange -= amount;
                }
                groupedTransactions[dateKey].details.totalCommission += commission;
                groupedTransactions[dateKey].details.totalFee += fee;
            });

            const sortedDates = Object.keys(groupedTransactions).sort().reverse();

            for (const dateKey of sortedDates) {
                const groupData = groupedTransactions[dateKey];
                const displayDate = new Date(dateKey).toDateString();
                const summary = groupData.details;

                const groupElement = document.createElement('div');
                groupElement.className = 'grouped-transaction';

                groupElement.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(this.parentElement)">
                        <span>${displayDate}</span>
                        <span>E-Chg: ${formatNumber(summary.emoneyChange)} | C-Chg: ${formatNumber(summary.cashChange)} | Comm: ${formatNumber(summary.totalCommission)} | Fee: ${formatNumber(summary.totalFee)}</span>
                    </div>
                    <div class="group-details">
                        ${groupData.items.map(item => {
                            const amountClass = (item.action === 'Cash In' || item.action === 'Received Money') ? 'positive' : 'negative';
                            let detailsHtml = '';
                            if (item.commission > 0) detailsHtml += `<span class="transaction-info-item"><strong>Comm:</strong> ${formatNumber(item.commission)}</span>`;
                            if (item.fee > 0) detailsHtml += `<span class="transaction-info-item"><strong>Fee:</strong> ${formatNumber(item.fee)}</span>`;
                            if (item.phone) detailsHtml += `<span class="transaction-info-item"><strong>Phone:</strong> ${item.phone}</span>`;
                            if (item.note) {
                                const truncatedNote = item.note.length > 50 ? item.note.substring(0, 50) + '...' : item.note;
                                detailsHtml += `<span class="transaction-info-item"><strong>Note:</strong> ${truncatedNote}</span>`;
                            }

                            return `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <span class="transaction-type">${item.type} - ${item.action}</span>
                                        <span class="transaction-amount ${amountClass}">${formatNumber(item.amount)}</span>
                                    </div>
                                    <div class="transaction-details-mobile">
                                        <span class="transaction-date">${new Date(item.date).toLocaleTimeString()}</span>
                                        <span class="transaction-info-item"><strong>ID:</strong> ${item.id}</span>
                                        ${detailsHtml}
                                    </div>
                                    <div class="transaction-actions">
                                        <button class="action-button-text edit" onclick="editTransaction(${item.originalIndex})"><i class="fas fa-edit"></i></button>
                                        <button class="action-button-text delete" onclick="deleteTransaction(${item.originalIndex})"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                listContainer.appendChild(groupElement);
            }
        }

        function editTransaction(index) {
            if (index < 0 || index >= transactions.length) { console.error("Invalid index for editTransaction:", index); showToast("Error loading transaction for editing.", "error"); return; }
            const transaction = transactions[index];

            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('transaction-date').value = transaction.date;

            const typeSelect = document.getElementById('transaction-type');
            const otherInput = document.getElementById('transaction-type-other');

            if (transaction.type && savedOtherTransactionTypes[transaction.type] || !Array.from(typeSelect.options).some(opt => opt.value === transaction.type)) {
                typeSelect.value = 'other';
                otherInput.value = transaction.type;
                otherInput.style.display = 'block';
                if (!savedOtherTransactionTypes[transaction.type]) {
                    savedOtherTransactionTypes[transaction.type] = transaction.type;
                    try { localStorage.setItem('moneyManager_savedOtherTransactionTypes', JSON.stringify(savedOtherTransactionTypes)); } catch (e) { console.error("Error saving custom transaction type during edit:", e); }
                    addOptionToSelect('transaction-type', transaction.type);
                }
            } else if (transaction.type) {
                typeSelect.value = transaction.type;
                otherInput.style.display = 'none'; otherInput.value = '';
            } else {
                typeSelect.value = 'Wave Money';
                otherInput.style.display = 'none'; otherInput.value = '';
            }

            document.getElementById('transaction-action').value = transaction.action;
            document.getElementById('transaction-amount').value = formatNumber(transaction.amount);
            document.getElementById('transaction-commission').value = transaction.commission ? formatNumber(transaction.commission) : '';
            document.getElementById('transaction-fee').value = transaction.fee ? formatNumber(transaction.fee) : '';

            if (transaction.phone && transaction.phone.startsWith('09')) document.getElementById('transaction-phone').value = transaction.phone.substring(2);
            else document.getElementById('transaction-phone').value = transaction.phone || '';

            document.getElementById('transaction-note').value = transaction.note || '';

            transactions.splice(index, 1); // Remove from array before editing
            updateSummariesBasedOnCurrentView(); updateTransactionList();
            showToast('Transaction loaded for editing');
            window.scrollTo(0, 0);
        }

        function deleteTransaction(index) {
            if (index < 0 || index >= transactions.length) { console.error("Invalid index for deleteTransaction:", index); showToast("Error deleting transaction.", "error"); return; }
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions.splice(index, 1);
                try {
                    localStorage.setItem('moneyManager_transactions', JSON.stringify(transactions));
                    showToast('Transaction deleted successfully', 'success');
                } catch (e) {
                    console.error("Error saving transactions after delete:", e);
                    showToast('Error saving changes after deletion', 'error');
                }
                updateSummariesBasedOnCurrentView(); updateTransactionList();
            }
        }

        function filterTransactions() {
            const typeFilter = document.getElementById('transaction-filter-type').value;
            const actionFilter = document.getElementById('transaction-filter-action').value;
            const dateFilterValue = document.getElementById('transaction-filter-date').value;

            let filtered = transactions;

            if (typeFilter !== 'all') filtered = filtered.filter(t => t.type === typeFilter);
            if (actionFilter !== 'all') filtered = filtered.filter(t => t.action === actionFilter);

            if (dateFilterValue) {
                try {
                    const filterDate = new Date(dateFilterValue);
                    filterDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(t => {
                        const transactionDateTime = new Date(t.date);
                        if (isNaN(transactionDateTime.getTime())) return false;
                        return transactionDateTime.getFullYear() === filterDate.getFullYear() &&
                               transactionDateTime.getMonth() === filterDate.getMonth() &&
                               transactionDateTime.getDate() === filterDate.getDate();
                    });
                } catch (e) {
                    console.error("Error applying date filter:", e);
                    showToast("Error applying date filter.", "error");
                    filtered = [];
                }
            }

            currentFilteredTransactions = filtered; // Store for summary updates
            updateTransactionList(filtered);
            updateSummariesBasedOnCurrentView();
        }

        function resetTransactionFilters() {
            document.getElementById('transaction-filter-type').value = 'all';
            document.getElementById('transaction-filter-action').value = 'all';
            document.getElementById('transaction-filter-date').value = '';
            currentFilteredTransactions = [];
            updateTransactionList();
            updateSummariesBasedOnCurrentView();
        }

        // --- DAILY MONEY TAB FUNCTIONS ---
        function toggleCommissionField() {
            const action = document.getElementById('money-action').value;
            const commissionGroup = document.getElementById('money-commission-group');
            commissionGroup.style.display = (action === 'Emoney In') ? 'block' : 'none';
            if (action !== 'Emoney In') document.getElementById('money-commission').value = '';
        }

        function calculateMoneyCommission() {
            const action = document.getElementById('money-action').value;
            const commissionPercentInput = document.getElementById('money-commission');
            const commissionGroup = document.getElementById('money-commission-group');

            if (action === 'Emoney In') {
                commissionGroup.style.display = 'block';
                let currentValue = commissionPercentInput.value;
                let cleanedValue = '';
                let dotFound = false;
                for (let i = 0; i < currentValue.length; i++) {
                    const char = currentValue[i];
                    if (char >= '0' && char <= '9') cleanedValue += char;
                    else if (char === '.' && !dotFound) { cleanedValue += '.'; dotFound = true; }
                }
                commissionPercentInput.value = cleanedValue;
            } else {
                 commissionPercentInput.value = ''; commissionGroup.style.display = 'none';
            }
        }

        function updateMoneyType() {
            const typeSelect = document.getElementById('money-type');
            const otherInput = document.getElementById('money-type-other');
            otherInput.style.display = typeSelect.value === 'other' ? 'block' : 'none';
            if (typeSelect.value === 'other') {
                if (otherInput.style.display === 'block' && document.activeElement !== otherInput) otherInput.focus();
            } else {
                otherInput.value = '';
            }
        }

        function addMoneyRecord() {
            const date = document.getElementById('money-date').value;
            const amount = parseFloat(document.getElementById('money-amount').value.replace(/,/g, ''));
            const action = document.getElementById('money-action').value;
            let type = document.getElementById('money-type').value;
            const otherInput = document.getElementById('money-type-other');
            let finalType = type;

            if (type === 'other') {
                const customType = otherInput.value.trim();
                if (!customType) { showToast('Please specify the other money record type', 'error'); return; }
                finalType = customType;
                if (!savedOtherMoneyTypes[finalType]) {
                    savedOtherMoneyTypes[finalType] = finalType;
                    try { localStorage.setItem('moneyManager_savedOtherMoneyTypes', JSON.stringify(savedOtherMoneyTypes)); } catch (e) { console.error("Error saving custom money type:", e); }
                    addOptionToSelect('money-type', finalType);
                }
            }

            const commissionPercentage = parseFloat(document.getElementById('money-commission').value.replace(/,/g, ''));
            let actualCommission = 0;
            if (action === 'Emoney In' && !isNaN(amount) && amount > 0 && !isNaN(commissionPercentage) && commissionPercentage >= 0) {
                actualCommission = (amount * commissionPercentage) / 100;
            }

            const note = document.getElementById('money-note').value.trim();

            // Validation
            if (!date) { showToast('Date/Time is required.', 'error'); return; }
            if (!finalType) { showToast('Type is required.', 'error'); return; }
            if (isNaN(amount) || amount <= 0) { showToast('Amount must be a positive number.', 'error'); return; }

            const record = { date, amount, action, type: finalType, commission: actualCommission, note };
            moneyRecords.unshift(record);

            try {
                localStorage.setItem('moneyManager_moneyRecords', JSON.stringify(moneyRecords));
                showToast('Money record added successfully!', 'success');
            } catch (e) {
                console.error("Error saving money records:", e);
                showToast('Error saving money record', 'error');
            }

            updateSummariesBasedOnCurrentView(); updateMoneyList(); clearMoneyForm();
        }

        function clearMoneyForm() {
            document.getElementById('money-amount').value = '';
            document.getElementById('money-action').value = 'Emoney In';
            document.getElementById('money-type').value = 'Wave Money';
            document.getElementById('money-type-other').value = ''; document.getElementById('money-type-other').style.display = 'none';
            document.getElementById('money-commission').value = ''; document.getElementById('money-commission-group').style.display = 'none';
            document.getElementById('money-note').value = '';
            updateDateTimeFields();
        }

        function updateMoneyList(filteredRecords = null) {
            const listContainer = document.querySelector('#money-list .transaction-list-items');
            const recordsToShow = filteredRecords !== null ? filteredRecords : moneyRecords;

            listContainer.innerHTML = '';
            if (recordsToShow.length === 0) { listContainer.innerHTML += '<p class="no-data">No money records found.</p>'; return; }

            const groupedRecords = {};
            recordsToShow.forEach((record, index) => { // 'index' here is from filteredRecords, not original
                const dateKey = new Date(record.date).toISOString().split('T')[0];
                const originalIndex = moneyRecords.findIndex(r => r.date === record.date && r.amount === record.amount && r.action === record.action); // Find index in original array
                if (!groupedRecords[dateKey]) {
                    groupedRecords[dateKey] = {
                        items: [],
                        details: { emoneyIn: 0, emoneyOut: 0, cashIn: 0, cashOut: 0, commission: 0 }
                    };
                }
                groupedRecords[dateKey].items.push({ ...record, originalIndex: originalIndex });
                const recordAmount = parseFloat(record.amount);
                if (record.action === 'Emoney In') {
                    groupedRecords[dateKey].details.emoneyIn += recordAmount;
                    groupedRecords[dateKey].details.commission += parseFloat(record.commission);
                } else if (record.action === 'Emoney Out') {
                    groupedRecords[dateKey].details.emoneyOut += recordAmount;
                } else if (record.action === 'Cash In') {
                    groupedRecords[dateKey].details.cashIn += recordAmount;
                } else if (record.action === 'Cash Out') {
                    groupedRecords[dateKey].details.cashOut += recordAmount;
                }
            });

            const sortedDates = Object.keys(groupedRecords).sort().reverse();

            for (const dateKey of sortedDates) {
                const groupData = groupedRecords[dateKey];
                const displayDate = new Date(dateKey).toDateString();
                const summary = groupData.details;

                const groupElement = document.createElement('div');
                groupElement.className = 'grouped-transaction';

                groupElement.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(this.parentElement)">
                        <span>${displayDate}</span>
                        <span>E-In: ${formatNumber(summary.emoneyIn)} | E-Out: ${formatNumber(summary.emoneyOut)} | C-In: ${formatNumber(summary.cashIn)} | C-Out: ${formatNumber(summary.cashOut)}</span>
                    </div>
                    <div class="group-details">
                        ${groupData.items.map(item => {
                            let detailsHtml = '';
                            if (item.commission > 0) detailsHtml += `<span class="transaction-info-item"><strong>Comm:</strong> ${formatNumber(item.commission)}</span>`;
                            if (item.note) {
                                const truncatedNote = item.note.length > 50 ? item.note.substring(0, 50) + '...' : item.note;
                                detailsHtml += `<span class="transaction-info-item"><strong>Note:</strong> ${truncatedNote}</span>`;
                            }
                            return `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <span class="transaction-type">${item.type}</span>
                                        <span class="transaction-amount">${formatNumber(item.amount)}</span>
                                    </div>
                                    <div class="transaction-details-mobile">
                                        <span class="transaction-date">${new Date(item.date).toLocaleTimeString()}</span>
                                        <span class="transaction-info-item"><strong>Action:</strong> ${item.action}</span>
                                        ${detailsHtml}
                                    </div>
                                    <div class="transaction-actions">
                                        <button class="action-button-text edit" onclick="editMoneyRecord(${item.originalIndex})"><i class="fas fa-edit"></i></button>
                                        <button class="action-button-text delete" onclick="deleteMoneyRecord(${item.originalIndex})"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                listContainer.appendChild(groupElement);
            }
        }

        function editMoneyRecord(index) {
            if (index < 0 || index >= moneyRecords.length) { showToast("Error loading money record for editing.", "error"); return; }
            const record = moneyRecords[index];

            document.getElementById('money-date').value = record.date;
            document.getElementById('money-amount').value = formatNumber(record.amount);
            document.getElementById('money-action').value = record.action;

            const typeSelect = document.getElementById('money-type');
            const otherInput = document.getElementById('money-type-other');

            if (record.type && savedOtherMoneyTypes[record.type] || !['Wave Money', 'KBZ Pay', 'Aya Pay', 'other'].includes(record.type)) {
                typeSelect.value = 'other';
                otherInput.value = record.type;
                otherInput.style.display = 'block';
                if (!savedOtherMoneyTypes[record.type]) {
                    savedOtherMoneyTypes[record.type] = record.type;
                    try { localStorage.setItem('moneyManager_savedOtherMoneyTypes', JSON.stringify(savedOtherMoneyTypes)); } catch (e) { console.error("Error saving custom money type during edit:", e); }
                    addOptionToSelect('money-type', record.type);
                }
            } else if (record.type) {
                typeSelect.value = record.type;
                otherInput.style.display = 'none'; otherInput.value = '';
            } else {
                typeSelect.value = 'Wave Money';
                otherInput.style.display = 'none'; otherInput.value = '';
            }

            toggleCommissionField();
            if (record.action === 'Emoney In') {
                document.getElementById('money-commission').value = record.commission ? formatNumber(record.commission) : '';
            } else {
                document.getElementById('money-commission').value = '';
            }

            document.getElementById('money-note').value = record.note || '';

            moneyRecords.splice(index, 1); // Remove from array for editing
            updateSummariesBasedOnCurrentView(); updateMoneyList();
            showToast('Money record loaded for editing');
            window.scrollTo(0, 0);
        }

        function deleteMoneyRecord(index) {
            if (index < 0 || index >= moneyRecords.length) { showToast("Error deleting money record.", "error"); return; }
            if (confirm('Are you sure you want to delete this record?')) {
                moneyRecords.splice(index, 1);
                try {
                    localStorage.setItem('moneyManager_moneyRecords', JSON.stringify(moneyRecords));
                    showToast('Money record deleted successfully', 'success');
                } catch (e) {
                    console.error("Error saving money records after delete:", e);
                    showToast('Error saving changes after deletion', 'error');
                }
                updateSummariesBasedOnCurrentView(); updateMoneyList();
            }
        }

        function filterMoneyRecords() {
            const moneyActionFilter = document.getElementById('money-filter-action').value;
            const dateFilterValue = document.getElementById('money-filter-date').value;

            let filtered = moneyRecords;

            if (moneyActionFilter !== 'all') filtered = filtered.filter(r => r.action === moneyActionFilter);

            if (dateFilterValue) {
                try {
                    const filterDate = new Date(dateFilterValue);
                    filterDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(r => {
                        const recordDateTime = new Date(r.date);
                        if (isNaN(recordDateTime.getTime())) return false;
                        return recordDateTime.getFullYear() === filterDate.getFullYear() &&
                               recordDateTime.getMonth() === filterDate.getMonth() &&
                               recordDateTime.getDate() === filterDate.getDate();
                    });
                } catch (e) {
                    console.error("Error applying date filter for money records:", e);
                    showToast("Error applying date filter.", "error");
                    filtered = [];
                }
            }

            updateMoneyList(filtered);
            updateSummariesBasedOnCurrentView();
        }

        function resetMoneyFilters() {
            document.getElementById('money-filter-action').value = 'all';
            document.getElementById('money-filter-date').value = '';
            updateMoneyList();
            updateSummariesBasedOnCurrentView();
        }

        // --- UPDATE DAILY SUMMARIES ---
        function updateDailySummaries(transactionsToProcess = null, recordsToSummarize = null) {
            const transactionFilterDateValue = document.getElementById('transaction-filter-date').value;
            const moneyFilterDateValue = document.getElementById('money-filter-date').value;

            // Determine the date range for the summary
            let relevantDateFilterValue = moneyFilterDateValue || transactionFilterDateValue; // Prioritize filter date from whichever tab is potentially active or if both are set
            let summaryStartDate, summaryEndDate;

            if (relevantDateFilterValue) {
                const filterDate = new Date(relevantDateFilterValue);
                summaryStartDate = new Date(filterDate); summaryStartDate.setHours(0, 0, 0, 0);
                summaryEndDate = new Date(filterDate); summaryEndDate.setHours(23, 59, 59, 999);
            } else {
                // Default to today if no filter is applied
                const today = new Date();
                summaryStartDate = new Date(today); summaryStartDate.setHours(0, 0, 0, 0);
                summaryEndDate = new Date(today); summaryEndDate.setHours(23, 59, 59, 999);
            }

           // --- Transaction Tab Daily Changes Calculation ---
            let dailyEMoneyBalanceFromTransactions = 0; // For the summary box: E-Money IN total
            let dailyCashBalanceFromTransactions = 0; // For the summary box: Cash IN total
            let totalDailyCommissionFromTransactions = 0;
            let totalDailyFeeFromTransactions = 0;
            const transactionsData = transactionsToProcess !== null ? transactionsToProcess : transactions;

            // Start with opening balances for the total card balances
            let currentEMoneyCardBalance = parseFloat(openingBalances.eMoney) || 0;
            let currentCashCardBalance = parseFloat(openingBalances.cash) || 0;

            transactionsData.forEach(t => {
                const transactionDateTime = new Date(t.date);
                // Check if the transaction falls within the summary date range
                if (transactionDateTime >= summaryStartDate && transactionDateTime <= summaryEndDate) {
                    const amount = parseFloat(t.amount);
                    const commission = parseFloat(t.commission) || 0;
                    const fee = parseFloat(t.fee) || 0;

                    // For the E-Money/Cash Balance cards (incorporating commissions/fees)
                    if (t.action === 'Cash In') { // Cash In: E-Money decreases, Cash increases
                        currentEMoneyCardBalance -= amount;
                        currentCashCardBalance += amount;
                    } else if (t.action === 'Cash Out') { // Cash Out: E-Money increases, Cash decreases
                        currentEMoneyCardBalance += amount;
                        currentCashCardBalance -= amount;
                    } else if (['Send Money', 'Payment', 'Phone Bill'].includes(t.action)) { // E-Money decreases, Cash increases
                        currentEMoneyCardBalance -= amount;
                        currentCashCardBalance += amount;
                    } else if (t.action === 'Received Money') { // E-Money increases, Cash decreases
                        currentEMoneyCardBalance += amount;
                        currentCashCardBalance -= amount;
                    }
                    totalDailyCommissionFromTransactions += commission;
                    totalDailyFeeFromTransactions += fee;

                    // For the Daily Summary boxes (only E-Money IN and Cash IN)
                    // E-Money IN actions are 'Cash Out' and 'Received Money'
                    if (t.action === 'Cash Out' || t.action === 'Received Money') {
                        dailyEMoneyBalanceFromTransactions += amount;
                    }
                    // Cash IN actions are 'Cash In'
                    if (t.action === 'Cash In') {
                        dailyCashBalanceFromTransactions += amount;
                    }
                }
            });

            // Apply commissions and fees to the card balances
            currentEMoneyCardBalance += totalDailyCommissionFromTransactions;
            currentCashCardBalance += totalDailyFeeFromTransactions;

            // Update the Transaction Tab Card Balances
            document.getElementById('e-money-balance').textContent = formatNumber(currentEMoneyCardBalance);
            document.getElementById('cash-balance').textContent = formatNumber(currentCashCardBalance);
            document.getElementById('total-balance').textContent = formatNumber(currentEMoneyCardBalance + currentCashCardBalance);

            // Update the Daily Summary boxes for Transactions Tab
            document.getElementById('daily-e-money').textContent = formatNumber(dailyEMoneyBalanceFromTransactions); // E-Money IN total
            document.getElementById('daily-cash').textContent = formatNumber(dailyCashBalanceFromTransactions); // Cash IN total
            document.getElementById('total-commission-summary').textContent = formatNumber(totalDailyCommissionFromTransactions);
            document.getElementById('total-fee-summary').textContent = formatNumber(totalDailyFeeFromTransactions);

            // Net Balance Change (Today) = E-Money Balance (Today) + Cash Balance (Today) for the summary boxes
            const netBalanceChangeSummary = dailyEMoneyBalanceFromTransactions + dailyCashBalanceFromTransactions;
            document.getElementById('daily-net-balance').textContent = formatNumber(netBalanceChangeSummary);

            const netBalanceElement = document.getElementById('daily-net-balance');
            netBalanceElement.className = netBalanceChangeSummary >= 0 ? 'positive' : 'negative';

           // --- Daily Money Tab Specific Summaries Calculation ---
            const dailySummaryForMoneyRecords = { emoneyIn: 0, emoneyOut: 0, cashIn: 0, cashOut: 0, commission: 0 };
            const moneyRecordsData = recordsToSummarize !== null ? recordsToSummarize : moneyRecords;

            moneyRecordsData.forEach(r => {
                const recordDateTime = new Date(r.date);
                if (recordDateTime >= summaryStartDate && recordDateTime <= summaryEndDate) {
                    const recordAmount = parseFloat(r.amount);
                    if (r.action === 'Emoney In') {
                        dailySummaryForMoneyRecords.emoneyIn += recordAmount;
                        dailySummaryForMoneyRecords.commission += parseFloat(r.commission);
                    } else if (r.action === 'Emoney Out') { dailySummaryForMoneyRecords.emoneyOut += recordAmount; }
                    else if (r.action === 'Cash In') { dailySummaryForMoneyRecords.cashIn += recordAmount; }
                    else if (r.action === 'Cash Out') { dailySummaryForMoneyRecords.cashOut += recordAmount; }
                }
            });

            document.getElementById('daily-emoney-in').textContent = formatNumber(dailySummaryForMoneyRecords.emoneyIn);
            document.getElementById('daily-emoney-out').textContent = formatNumber(dailySummaryForMoneyRecords.emoneyOut);
            document.getElementById('daily-cash-in').textContent = formatNumber(dailySummaryForMoneyRecords.cashIn);
            document.getElementById('daily-cash-out').textContent = formatNumber(dailySummaryForMoneyRecords.cashOut);

            // Calculate the net change for the Money Records summary
            let dailyEMoneyBalanceChangeFromMoneyRecords = (dailySummaryForMoneyRecords.emoneyIn || 0) - (dailySummaryForMoneyRecords.emoneyOut || 0);
            let dailyCashBalanceChangeFromMoneyRecords = (dailySummaryForMoneyRecords.cashIn || 0) - (dailySummaryForMoneyRecords.cashOut || 0);

            const totalDailyRemainingBalance = dailyEMoneyBalanceChangeFromMoneyRecords + dailyCashBalanceChangeFromMoneyRecords;
            document.getElementById('daily-remaining').textContent = formatNumber(totalDailyRemainingBalance);

            if (dailySummaryForMoneyRecords.commission > 0) {
                document.getElementById('daily-money-commission-item').style.display = 'flex';
                document.getElementById('daily-money-commission').textContent = formatNumber(dailySummaryForMoneyRecords.commission);
            } else {
                document.getElementById('daily-money-commission-item').style.display = 'none';
            }

            // Auto-expand summary sections if they contain relevant data
            const transactionSummarySection = document.getElementById('transaction').querySelector('.summary-section');
            if (transactionSummarySection) {
                const hasTransactionData = (transactionsData.length > 0 || dailyEMoneyBalanceFromTransactions !== 0 || dailyCashBalanceFromTransactions !== 0 || totalDailyCommissionFromTransactions !== 0 || totalDailyFeeFromTransactions !== 0);
                if (hasTransactionData && !transactionSummarySection.classList.contains('expanded')) toggleExpand(transactionSummarySection);
                else if (!hasTransactionData && transactionSummarySection.classList.contains('expanded')) toggleExpand(transactionSummarySection);
            }

            const dailyMoneySummarySection = document.querySelector('#daily-money .summary-section');
            if (dailyMoneySummarySection) {
                const hasMoneyRecordData = (moneyRecordsData.length > 0 || dailySummaryForMoneyRecords.emoneyIn !== 0 || dailySummaryForMoneyRecords.emoneyOut !== 0 || dailySummaryForMoneyRecords.cashIn !== 0 || dailySummaryForMoneyRecords.cashOut !== 0 || dailySummaryForMoneyRecords.commission !== 0);
                if (hasMoneyRecordData && !dailyMoneySummarySection.classList.contains('expanded')) toggleExpand(dailyMoneySummarySection);
                else if (!hasMoneyRecordData && dailyMoneySummarySection.classList.contains('expanded')) toggleExpand(dailyMoneySummarySection);
            }
        }

        function toggleExpand(element) {
            element.classList.toggle('expanded');
            const summaryList = element.querySelector('.summary-list');
            if (summaryList) summaryList.style.display = element.classList.contains('expanded') ? 'block' : 'none';
            const arrow = element.querySelector('h2 .arrow');
            if (arrow) arrow.style.transform = element.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function updateSummariesBasedOnCurrentView() {
            let filteredTransactionsForSummary = transactions;
            const transactionFilterDateValue = document.getElementById('transaction-filter-date').value;
            if (transactionFilterDateValue) {
                try {
                    const filterDate = new Date(transactionFilterDateValue); filterDate.setHours(0, 0, 0, 0);
                    filteredTransactionsForSummary = transactions.filter(t => {
                        const transactionDateTime = new Date(t.date);
                        if (isNaN(transactionDateTime.getTime())) return false;
                        return transactionDateTime.getFullYear() === filterDate.getFullYear() &&
                               transactionDateTime.getMonth() === filterDate.getMonth() &&
                               transactionDateTime.getDate() === filterDate.getDate();
                    });
                } catch (e) { console.error("Error during transaction filtering for summary update:", e); filteredTransactionsForSummary = []; }
            }

            let filteredMoneyRecordsForSummary = moneyRecords;
            const moneyActionFilterValue = document.getElementById('money-filter-action').value;
            const moneyDateFilterValue = document.getElementById('money-filter-date').value;

            if (moneyActionFilterValue !== 'all') {
                filteredMoneyRecordsForSummary = filteredMoneyRecordsForSummary.filter(r => r.action === moneyActionFilterValue);
            }
            if (moneyDateFilterValue) {
                try {
                    const filterDate = new Date(moneyDateFilterValue); filterDate.setHours(0, 0, 0, 0);
                    filteredMoneyRecordsForSummary = filteredMoneyRecordsForSummary.filter(r => {
                        const recordDateTime = new Date(r.date);
                        if (isNaN(recordDateTime.getTime())) return false;
                        return recordDateTime.getFullYear() === filterDate.getFullYear() &&
                               recordDateTime.getMonth() === filterDate.getMonth() &&
                               recordDateTime.getDate() === filterDate.getDate();
                    });
                } catch (e) { console.error("Error during money record filtering for summary update:", e); filteredMoneyRecordsForSummary = []; }
            }

            if (document.getElementById('daily-money').classList.contains('active') && document.getElementById('money-list').classList.contains('expanded')) updateMoneyList(filteredMoneyRecordsForSummary);
            if (document.getElementById('transaction').classList.contains('active') && document.getElementById('transaction-list').classList.contains('expanded')) updateTransactionList(currentFilteredTransactions);

            updateDailySummaries(filteredTransactionsForSummary, filteredMoneyRecordsForSummary);
            updateTransactionTabBalances();
        }

        // --- EXPORT FUNCTIONS (EXCEL & PDF) ---
        function exportToExcel() {
            if (transactions.length === 0) { showToast('No transactions to export', 'error'); return; }

            const dataForExcel = transactions.map(t => ({
                'Transaction ID': t.id,
                'Date': new Date(t.date).toLocaleString(),
                'Type': t.type,
                'Action': t.action,
                'Amount': t.amount,
                'Commission': t.commission || 0,
                'Fee': t.fee || 0,
                'Phone': t.phone,
                'Note': t.note
            }));

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");

            try { XLSX.writeFile(wb, "MoneyManager_Transactions.xlsx"); showToast('Transactions exported to Excel!', 'success'); }
            catch (e) { console.error("Error during Excel export:", e); showToast("Error exporting to Excel", "error"); }
        }

        function exportToPDF() {
            if (transactions.length === 0) { showToast('No transactions to export', 'error'); return; }

            const transactionListSection = document.getElementById('transaction-list');
            if (!transactionListSection) { showToast('Transaction list section not found', 'error'); return; }

            if (!transactionListSection.classList.contains('expanded')) toggleTransactionList();
            if (transactionListSection.querySelector('.grouped-transaction') === null || transactionListSection.querySelector('.no-data')) {
                 if (transactions.length > 0) updateTransactionList();
            }

            setTimeout(() => {
                const captureTargetElement = document.getElementById('transaction');
                if (!captureTargetElement) { showToast('Transaction tab content not found for capture', 'error'); return; }

                const tempWrapper = document.createElement('div');
                tempWrapper.style.cssText = `
                    position: absolute; left: -9999px; top: 0; opacity: 1; width: auto; height: auto; visibility: visible;
                    padding: 20px; background-color: #ffffff; z-index: 10000; font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
                    color: #212529; font-size: 14px; line-height: 1.6; box-sizing: border-box;
                `;

                const clonedListItems = transactionListSection.querySelector('.transaction-list-items').cloneNode(true);
                clonedListItems.querySelectorAll('.transaction-actions').forEach(el => el.style.display = 'none');
                clonedListItems.querySelectorAll('.transaction-item.active').forEach(item => item.classList.remove('active'));

                tempWrapper.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 30px; color: #007bff; font-size: 2em; border-bottom: 2px solid #007bff; padding-bottom: 15px;">Transaction History</h2>
                    <div style="margin-bottom: 25px;">${clonedListItems.innerHTML}</div>
                `;
                document.body.appendChild(tempWrapper);

                html2canvas(tempWrapper, { useCORS: true, logging: false, letterRendering: true, scale: 2, backgroundColor: '#ffffff' })
                .then(canvas => {
                    if (tempWrapper.parentNode) document.body.removeChild(tempWrapper);

                    const imgData = canvas.toDataURL('image/png');
                    let pdf;
                    try {
                        if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') throw new Error("jsPDF library is not loaded.");
                        pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    } catch (e) { console.error("PDF initialization error:", e); showToast("Error initializing PDF generator.", "error"); return; }

                    const imgProps = canvas; const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight();
                    const aspectRatio = imgProps.height / imgProps.width;
                    let scaledHeight = pdfWidth * aspectRatio;
                    const pageMargin = 15;

                    if (scaledHeight > pdfHeight - (2 * pageMargin)) scaledHeight = pdfHeight - (2 * pageMargin);

                    pdf.addImage(imgData, 'PNG', 0, pageMargin, pdfWidth, scaledHeight);
                    try { pdf.save("MoneyManager_Transactions.pdf"); showToast('Transactions exported to PDF!', 'success'); }
                    catch (e) { console.error("Error saving PDF:", e); showToast("Error saving PDF", "error"); }
                })
                .catch(error => {
                    if (tempWrapper.parentNode) document.body.removeChild(tempWrapper);
                    console.error("Error capturing transactions for PDF: ", error);
                    showToast('Failed to export transactions to PDF: ' + error.message, 'error');
                });
            }, 300);
        }

        // --- TOGGLE VISIBILITY OF COLLAPSIBLE LISTS ---
        function toggleTransactionList() {
            const listContainer = document.getElementById('transaction-list');
            listContainer.classList.toggle('expanded');
            if (listContainer.classList.contains('expanded') && (listContainer.querySelector('.grouped-transaction') === null || listContainer.querySelector('.no-data'))) {
                 if (transactions.length > 0) updateTransactionList();
            }
        }

        function toggleMoneyList() {
            const listContainer = document.getElementById('money-list');
            listContainer.classList.toggle('expanded');
            if (listContainer.classList.contains('expanded') && (listContainer.querySelector('.grouped-transaction') === null || listContainer.querySelector('.no-data'))) {
                 if (moneyRecords.length > 0) updateMoneyList();
            }
        }

        function toggleTransactionSummary() {
            const summarySection = document.getElementById('transaction').querySelector('.summary-section');
            toggleExpand(summarySection);
        }

        function toggleDailyMoneySummary() {
            const summarySection = document.getElementById('daily-money').querySelector('.summary-section');
            toggleExpand(summarySection);
        }

        function toggleGroup(groupElement) { groupElement.classList.toggle('expanded'); }

        // --- DEBT/CREDIT TAB FUNCTIONS ---
        function updateExistingDebtNames() {
            const nameSet = new Set();
            debts.forEach(debtGroup => nameSet.add(debtGroup.name.toLowerCase()));
            existingDebtNames = Array.from(nameSet);
        }

        function handleDebtNameInput(event) {
            const inputField = event.target;
            const name = inputField.value.trim();
            const suggestionsContainer = document.getElementById('debt-name-suggestions');

            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
            }
            if (name.length < 2) return;

            const matchingNames = existingDebtNames
                .filter(existingName => existingName.includes(name.toLowerCase()))
                .slice(0, 5);

            if (matchingNames.length > 0 && suggestionsContainer) {
                suggestionsContainer.style.display = 'block';
                matchingNames.forEach(match => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'debt-suggestion-item';
                    suggestionItem.textContent = match.charAt(0).toUpperCase() + match.slice(1);
                    suggestionItem.onclick = () => {
                        inputField.value = suggestionItem.textContent;
                        if (suggestionsContainer) suggestionsContainer.style.display = 'none';
                        if (hideSuggestionsOnClickOutside) {
                            document.removeEventListener('click', hideSuggestionsOnClickOutside);
                            hideSuggestionsOnClickOutside = null;
                        }
                    };
                    suggestionsContainer.appendChild(suggestionItem);
                });

                if (!hideSuggestionsOnClickOutside) {
                    hideSuggestionsOnClickOutside = (e) => {
                        if (suggestionsContainer && !suggestionsContainer.contains(e.target) && !inputField.contains(e.target)) {
                            suggestionsContainer.style.display = 'none';
                            document.removeEventListener('click', hideSuggestionsOnClickOutside);
                            hideSuggestionsOnClickOutside = null;
                        }
                    };
                    document.addEventListener('click', hideSuggestionsOnClickOutside);
                }
            }
        }

        function addOrUpdateDebtEntry() {
            const nameInput = document.getElementById('debt-name');
            const name = nameInput.value.trim();
            const type = document.getElementById('debt-type').value;
            const amount = parseFloat(document.getElementById('debt-amount').value.replace(/,/g, ''));
            const date = document.getElementById('debt-date').value;
            const note = document.getElementById('debt-note').value.trim();

            // Validation
            if (!name) { showToast("Name is required.", "error"); return; }
            if (isNaN(amount) || amount <= 0) { showToast("Amount must be a positive number.", "error"); return; }
            if (!date) { showToast("Date/Time is required.", "error"); return; }

            let historyEntryType;
            if (editingDebtEntry) {
                historyEntryType = editingDebtEntry.type;
            } else {
                historyEntryType = type === 'payable' ? 'initial_payable' : 'initial_receivable';
            }

            const newOrUpdatedEntry = {
                id: editingDebtEntry ? editingDebtEntry.id : Date.now().toString(),
                date: date, amount: amount, type: historyEntryType, note: note
            };

            let debtGroupIndex = debts.findIndex(debt => debt.name === name && debt.type === type);
            let targetGroupType = type;

            if (debtGroupIndex === -1) {
                if (!existingDebtNames.includes(name.toLowerCase())) {
                     existingDebtNames.push(name.toLowerCase());
                }
                debts.push({ name: name, type: targetGroupType, history: [], id: `debtGroup_${Date.now()}` });
                debtGroupIndex = debts.length - 1;
            }

            let needsReconciliation = editingDebtEntry && editingDebtEntry.groupType !== targetGroupType;

            if (editingDebtEntry && needsReconciliation) {
                const originalGroupIndex = debts.findIndex(debt => debt.name === name && debt.type === editingDebtEntry.groupType);
                if (originalGroupIndex !== -1) {
                    const originalEntryIndex = debts[originalGroupIndex].history.findIndex(entry => entry.id.toString() === editingDebtEntry.id.toString());
                    if (originalEntryIndex !== -1) {
                        debts[originalGroupIndex].history.splice(originalEntryIndex, 1);
                        if (debts[originalGroupIndex].history.length === 0) debts.splice(originalGroupIndex, 1);
                    }
                }
                debts[debtGroupIndex].history.push(newOrUpdatedEntry);
            } else if (editingDebtEntry) {
                const entryIndexInGroup = debts[debtGroupIndex].history.findIndex(entry => entry.id.toString() === editingDebtEntry.id.toString());
                if (entryIndexInGroup !== -1) debts[debtGroupIndex].history[entryIndexInGroup] = newOrUpdatedEntry;
                else debts[debtGroupIndex].history.push(newOrUpdatedEntry);
            } else {
                debts[debtGroupIndex].history.push(newOrUpdatedEntry);
            }

            updateExistingDebtNames();
            saveData();
            renderDebts();
            clearDebtForm();
            showToast(editingDebtEntry ? 'Debt/Credit entry updated successfully!' : 'Debt/Credit added successfully!', 'success');
            editingDebtEntry = null;
            updateAddUpdateButtonText();
        }

        function updateAddUpdateButtonText() {
            const button = document.getElementById('add-update-debt-button');
            button.innerHTML = editingDebtEntry ? '<i class="fas fa-sync-alt"></i> Update Entry' : '<i class="fas fa-save"></i> Add Debt/Credit';
        }

        function clearDebtForm() {
            document.getElementById('debt-name').value = '';
            const suggestionsContainer = document.getElementById('debt-name-suggestions');
            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = ''; suggestionsContainer.style.display = 'none';
            }
            if (hideSuggestionsOnClickOutside) {
                document.removeEventListener('click', hideSuggestionsOnClickOutside);
                hideSuggestionsOnClickOutside = null;
            }

            document.getElementById('debt-type').value = 'payable';
            document.getElementById('debt-amount').value = '';
            updateDateTimeFields();
            document.getElementById('debt-note').value = '';
            updateDebtFormVisibility();

            editingDebtEntry = null;
            updateAddUpdateButtonText();
        }

        function renderDebts() {
            const payableList = document.querySelector('#payable-debts-list .transaction-list-items');
            const receivableList = document.querySelector('#receivable-debts-list .transaction-list-items');
            payableList.innerHTML = ''; receivableList.innerHTML = '';

            let totalPayable = 0; let totalReceivable = 0;
            const aggregatedDebts = {};

            debts.forEach(debtGroup => {
                const { name, type, history, id } = debtGroup;
                if (!aggregatedDebts[name]) aggregatedDebts[name] = { payableHistory: [], receivableHistory: [] };
                if (type === 'payable') aggregatedDebts[name].payableHistory.push(...history.map(h => ({...h, groupId: id})));
                else aggregatedDebts[name].receivableHistory.push(...history.map(h => ({...h, groupId: id})));
            });

            const sortedNames = Object.keys(aggregatedDebts).sort();

            sortedNames.forEach(name => {
                const debtAggregation = aggregatedDebts[name];

                // Process Payable Debts
                if (debtAggregation.payableHistory.length > 0) {
                    let currentPayableTotal = 0;
                    debtAggregation.payableHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    debtAggregation.payableHistory.forEach(entry => {
                        if (['initial_payable', 'payment_out'].includes(entry.type)) currentPayableTotal += entry.amount;
                        else if (['initial_receivable', 'payment_in'].includes(entry.type)) currentPayableTotal -= entry.amount;
                    });
                    currentPayableTotal = Math.max(0, currentPayableTotal);

                    if (currentPayableTotal > 0) {
                        totalPayable += currentPayableTotal;
                        const payableDiv = createDebtListItem(name, 'payable', currentPayableTotal, debtAggregation.payableHistory);
                        payableList.appendChild(payableDiv);
                    }
                }

                // Process Receivable Credits
                if (debtAggregation.receivableHistory.length > 0) {
                    let currentReceivableTotal = 0;
                    debtAggregation.receivableHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    debtAggregation.receivableHistory.forEach(entry => {
                        if (['initial_receivable', 'payment_in'].includes(entry.type)) currentReceivableTotal += entry.amount;
                        else if (['initial_payable', 'payment_out'].includes(entry.type)) currentReceivableTotal -= entry.amount;
                    });
                    currentReceivableTotal = Math.max(0, currentReceivableTotal);

                    if (currentReceivableTotal > 0) {
                        totalReceivable += currentReceivableTotal;
                        const receivableDiv = createDebtListItem(name, 'receivable', currentReceivableTotal, debtAggregation.receivableHistory);
                        receivableList.appendChild(receivableDiv);
                    }
                }
            });

            document.getElementById('total-payable-amount').textContent = formatNumber(totalPayable);
            document.getElementById('total-receivable-amount').textContent = formatNumber(totalReceivable);

            if (payableList.children.length === 0) payableList.innerHTML = '<p class="no-data">No payable debts found.</p>';
            if (receivableList.children.length === 0) receivableList.innerHTML = '<p class="no-data">No receivable credits found.</p>';
        }

        function createDebtListItem(name, type, amount, history) {
            const debtDiv = document.createElement('div');
            debtDiv.className = 'debt-list-item';
            debtDiv.dataset.name = name; debtDiv.dataset.type = type;

            const amountClass = type === 'payable' ? 'negative' : 'positive';
            const formattedAmount = formatNumber(amount);
            const historyHtml = generateHistoryHtml(history);

            debtDiv.innerHTML = `
                <div class="debt-item-summary sticky-header" onclick="toggleDebtDetails(event, '${name.replace(/'/g, "\\'")}', '${type}')">
                    <div class="debt-name">${name}</div>
                    <span class="debt-amount ${amountClass}">${formattedAmount}</span>
                </div>
                <div class="debt-item-details-expanded" id="debt-details-${name.replace(/'/g, "\\'")}-${type}">
                    <div class="debt-actions">
                        <button class="action-button-text delete" onclick="deleteDebtGroup('${name.replace(/'/g, "\\'")}','${type}')"><i class="fas fa-trash-alt"></i> Delete Group</button>
                        <button class="action-button-text secondary" onclick="toggleDetailsButtonAction('${name.replace(/'/g, "\\'")}', '${type}')"><i class="fas fa-ellipsis-h"></i> Details</button>
                    </div>
                    <div class="debt-details">
                        <span class="debt-type">${type === 'payable' ? 'You owe' : 'Owed to you'}</span>
                        ${historyHtml ? `<span class="debt-note">${history.length} entries</span>` : ''}
                    </div>
                    ${historyHtml}
                </div>
            `;
            return debtDiv;
        }

        function toggleDebtDetails(event, name, type) {
            if (event.target.closest('.debt-actions') || event.target.closest('button')) return;
            const detailsDiv = document.getElementById(`debt-details-${name.replace(/'/g, "\\'")}-${type}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('visible');
                updateToggleButtonIconAndText(name, type);
            }
        }

        function toggleDetailsButtonAction(name, type) {
            const detailsDiv = document.getElementById(`debt-details-${name.replace(/'/g, "\\'")}-${type}`);
            const toggleButton = detailsDiv ? detailsDiv.querySelector('.debt-actions button[onclick*="toggleDetailsButtonAction"]') : null;

            if (toggleButton && detailsDiv) {
                detailsDiv.classList.toggle('visible');
                updateToggleButtonIconAndText(name, type);
            }
        }

        function updateToggleButtonIconAndText(name, type) {
            const detailsDiv = document.getElementById(`debt-details-${name.replace(/'/g, "\\'")}-${type}`);
            const toggleButton = detailsDiv ? detailsDiv.querySelector('.debt-actions button[onclick*="toggleDetailsButtonAction"]') : null;

            if (toggleButton && detailsDiv) {
                const iconElement = toggleButton.querySelector('.fa-ellipsis-h, .fa-times');
                if (detailsDiv.classList.contains('visible')) {
                    if (iconElement) iconElement.classList.replace('fa-ellipsis-h', 'fa-times');
                    toggleButton.innerHTML = '<i class="fas fa-times"></i> Hide Details';
                } else {
                    if (iconElement) iconElement.classList.replace('fa-times', 'fa-ellipsis-h');
                    toggleButton.innerHTML = '<i class="fas fa-ellipsis-h"></i> Details';
                }
            }
        }

        function editDebtHistoryEntry(entryId) {
            for (let i = 0; i < debts.length; i++) {
                const debtGroup = debts[i];
                const historyEntryIndex = debtGroup.history.findIndex(entry => entry.id.toString() === entryId.toString());

                if (historyEntryIndex !== -1) {
                    const entryToEdit = debtGroup.history[historyEntryIndex];

                    document.getElementById('debt-name').value = debtGroup.name;
                    document.getElementById('debt-type').value = debtGroup.type;
                    document.getElementById('debt-amount').value = formatNumber(entryToEdit.amount);
                    document.getElementById('debt-date').value = entryToEdit.date;
                    document.getElementById('debt-note').value = entryToEdit.note || '';
                    updateDebtFormVisibility();

                    editingDebtEntry = {
                        id: entryToEdit.id, type: entryToEdit.type,
                        groupType: debtGroup.type, groupIdx: i, entryIdx: historyEntryIndex
                    };
                    updateAddUpdateButtonText();

                    debtGroup.history.splice(historyEntryIndex, 1); // Remove from original location
                    if (debtGroup.history.length === 0) debts.splice(i, 1);

                    saveData(); renderDebts();
                    showToast('Entry loaded for editing. Update form and click Update.');
                    window.scrollTo(0, 0);
                    return;
                }
            }
            showToast("Entry not found for editing.", "error");
        }

        function deleteDebtHistoryEntry(entryId) {
            if (!confirm('Are you sure you want to delete this history entry?')) return;

            for (let i = 0; i < debts.length; i++) {
                const debtGroup = debts[i];
                const historyEntryIndex = debtGroup.history.findIndex(entry => entry.id.toString() === entryId.toString());

                if (historyEntryIndex !== -1) {
                    debtGroup.history.splice(historyEntryIndex, 1);
                    if (debtGroup.history.length === 0) debts.splice(i, 1);

                    updateExistingDebtNames(); saveData(); renderDebts();
                    showToast('History entry deleted successfully', 'success');
                    return;
                }
            }
            showToast("Entry not found for deletion.", "error");
        }

        function deleteDebtGroup(name, type) {
             if (!confirm(`Are you sure you want to delete the entire group for "${name}" (${type})?`)) return;

            const groupIndexToDelete = debts.findIndex(debt => debt.name === name && debt.type === type);
            if (groupIndexToDelete !== -1) {
                debts.splice(groupIndexToDelete, 1);
                updateExistingDebtNames(); saveData(); renderDebts();
                showToast('Debt group deleted successfully');
            } else {
                showToast('Group not found for deletion.', 'error');
            }
        }

        function updateDebtFormVisibility() { /* No current implementation needed */ }

        function filterDebts() {
            const nameFilter = document.getElementById('debt-filter-name').value.toLowerCase();
            let filteredDebts = debts;
            if (nameFilter) {
                filteredDebts = filteredDebts.filter(debtGroup => debtGroup.name.toLowerCase().includes(nameFilter));
            }
            renderDebtsFiltered(filteredDebts);
        }

        function resetDebtFilters() {
            document.getElementById('debt-filter-name').value = '';
            renderDebts();
        }

        function generateHistoryHtml(history) {
            if (!history || history.length === 0) return '';

            let historyHtml = '<div class="debt-history-list">';
            const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedHistory.forEach(entry => {
                const entryDateTime = new Date(entry.date);
                const entryDisplay = entryDateTime.toLocaleString();

                let amountClass = ''; let entryTypeLabel = '';
                switch (entry.type) {
                    case 'initial_payable': amountClass = 'negative'; entryTypeLabel = 'Initial Debt'; break;
                    case 'initial_receivable': amountClass = 'positive'; entryTypeLabel = 'Initial Credit'; break;
                    case 'payment_out': amountClass = 'negative'; entryTypeLabel = 'Paid'; break;
                    case 'payment_in': amountClass = 'positive'; entryTypeLabel = 'Received'; break;
                    default:
                        amountClass = '';
                        entryTypeLabel = entry.type.charAt(0).toUpperCase() + entry.type.slice(1).replace('_', ' ');
                        break;
                }
                const noteDisplay = entry.note ? ` - ${entry.note}` : '';

                historyHtml += `
                    <div class="debt-history-item">
                        <span>${entryDisplay} - ${entryTypeLabel}${noteDisplay}</span>
                        <span class="${amountClass}">${formatNumber(entry.amount)}</span>
                        <div class="debt-history-actions">
                            <button class="action-button-text edit" onclick="editDebtHistoryEntry('${entry.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-button-text delete" onclick="deleteDebtHistoryEntry('${entry.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            });
            historyHtml += '</div>';
            return historyHtml;
        }

        function renderDebtsFiltered(filteredDebts) {
            const payableList = document.querySelector('#payable-debts-list .transaction-list-items');
            const receivableList = document.querySelector('#receivable-debts-list .transaction-list-items');
            payableList.innerHTML = ''; receivableList.innerHTML = '';

            let totalPayable = 0; let totalReceivable = 0;
            const aggregatedDebts = {};

            filteredDebts.forEach(debtGroup => { // Iterate over the filtered list
                const { name, type, history, id } = debtGroup;
                if (!aggregatedDebts[name]) aggregatedDebts[name] = { payableHistory: [], receivableHistory: [] };
                if (type === 'payable') aggregatedDebts[name].payableHistory.push(...history.map(h => ({...h, groupId: id})));
                else aggregatedDebts[name].receivableHistory.push(...history.map(h => ({...h, groupId: id})));
            });

            const sortedNames = Object.keys(aggregatedDebts).sort();

            sortedNames.forEach(name => {
                const debtAggregation = aggregatedDebts[name];

                // Process Payable Debts
                if (debtAggregation.payableHistory.length > 0) {
                    let currentPayableTotal = 0;
                    debtAggregation.payableHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    debtAggregation.payableHistory.forEach(entry => {
                        if (['initial_payable', 'payment_out'].includes(entry.type)) currentPayableTotal += entry.amount;
                        else if (['initial_receivable', 'payment_in'].includes(entry.type)) currentPayableTotal -= entry.amount;
                    });
                    currentPayableTotal = Math.max(0, currentPayableTotal);

                    if (currentPayableTotal > 0) {
                        totalPayable += currentPayableTotal;
                        const payableDiv = createDebtListItem(name, 'payable', currentPayableTotal, debtAggregation.payableHistory);
                        payableList.appendChild(payableDiv);
                    }
                }

                // Process Receivable Credits
                if (debtAggregation.receivableHistory.length > 0) {
                    let currentReceivableTotal = 0;
                    debtAggregation.receivableHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    debtAggregation.receivableHistory.forEach(entry => {
                        if (['initial_receivable', 'payment_in'].includes(entry.type)) currentReceivableTotal += entry.amount;
                        else if (['initial_payable', 'payment_out'].includes(entry.type)) currentReceivableTotal -= entry.amount;
                    });
                    currentReceivableTotal = Math.max(0, currentReceivableTotal);

                    if (currentReceivableTotal > 0) {
                        totalReceivable += currentReceivableTotal;
                        const receivableDiv = createDebtListItem(name, 'receivable', currentReceivableTotal, debtAggregation.receivableHistory);
                        receivableList.appendChild(receivableDiv);
                    }
                }
            });

            document.getElementById('total-payable-amount').textContent = formatNumber(totalPayable);
            document.getElementById('total-receivable-amount').textContent = formatNumber(totalReceivable);

            if (payableList.children.length === 0) payableList.innerHTML = '<p class="no-data">No payable debts found.</p>';
            if (receivableList.children.length === 0) receivableList.innerHTML = '<p class="no-data">No receivable credits found.</p>';
        }

        // --- EXPENSE TAB SPECIFIC FUNCTIONS ---
        function updateExpenseCategoryVisibility() {
            const categorySelect = document.getElementById('expense-category');
            const otherInput = document.getElementById('expense-category-other');
            otherInput.style.display = categorySelect.value === 'other' ? 'block' : 'none';
            if (categorySelect.value === 'other') {
                if (otherInput.style.display === 'block' && document.activeElement !== otherInput) otherInput.focus();
            } else {
                otherInput.value = '';
            }
        }

        function updatePaymentMethodVisibility() {
            const paymentMethodSelect = document.getElementById('expense-payment-method');
            const otherInput = document.getElementById('expense-payment-method-other');
            otherInput.style.display = paymentMethodSelect.value === 'Other' ? 'block' : 'none';
            if (paymentMethodSelect.value === 'Other') {
                if (otherInput.style.display === 'block' && document.activeElement !== otherInput) otherInput.focus();
            } else {
                otherInput.value = '';
            }
        }

        function addExpenseEntry() {
            const date = document.getElementById('expense-date').value;
            const type = document.getElementById('expense-type').value;
            const categorySelect = document.getElementById('expense-category');
            const categoryOtherInput = document.getElementById('expense-category-other');
            let finalCategory = categorySelect.value;

            if (finalCategory === 'other') {
                const customCategory = categoryOtherInput.value.trim();
                if (!customCategory) { showToast('Please specify the other category', 'error'); return; }
                finalCategory = customCategory;
                if (!savedExpenseCategories[finalCategory]) {
                    savedExpenseCategories[finalCategory] = finalCategory;
                    try { localStorage.setItem('moneyManager_savedExpenseCategories', JSON.stringify(savedExpenseCategories)); } catch (e) { console.error("Error saving custom expense category:", e); }
                    addOptionToSelect('expense-category', finalCategory);
                }
            }

            const amount = parseFloat(document.getElementById('expense-amount').value.replace(/,/g, ''));
            const paymentMethod = document.getElementById('expense-payment-method').value;
            const paymentMethodOtherInput = document.getElementById('expense-payment-method-other');
            let finalPaymentMethod = paymentMethod;
            if (paymentMethod === 'Other') {
                const customPaymentMethod = paymentMethodOtherInput.value.trim();
                if (!customPaymentMethod) { showToast('Please specify the other payment method', 'error'); return; }
                finalPaymentMethod = customPaymentMethod;
            }
            const note = document.getElementById('expense-note').value.trim();

            // Validation
            if (!date) { showToast('Date/Time is required.', 'error'); return; }
            if (!finalCategory) { showToast('Category is required.', 'error'); return; }
            if (isNaN(amount) || amount <= 0) { showToast('Amount must be a positive number.', 'error'); return; }
            if (!finalPaymentMethod) { showToast('Payment Method is required.', 'error'); return; }

            const newEntry = { id: Date.now().toString(), date, type, category: finalCategory, amount, paymentMethod: finalPaymentMethod, note };
            expenseEntries.unshift(newEntry);

            try {
                localStorage.setItem('moneyManager_expenseEntries', JSON.stringify(expenseEntries));
                showToast('Expense/Income entry added successfully!', 'success');
            } catch (e) {
                console.error("Error saving expense entries:", e);
                showToast('Error saving expense entry', 'error');
            }

            updateExpenseSummaries(); renderExpenseEntries(); clearExpenseForm();
        }

        function clearExpenseForm() {
            document.getElementById('expense-date').value = ''; updateDateTimeFields();
            document.getElementById('expense-type').value = 'Expense';
            document.getElementById('expense-category').value = 'Rent';
            document.getElementById('expense-category-other').value = ''; document.getElementById('expense-category-other').style.display = 'none';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-payment-method').value = 'E-Money';
            document.getElementById('expense-payment-method-other').value = ''; document.getElementById('expense-payment-method-other').style.display = 'none';
            document.getElementById('expense-note').value = '';
            updateExpenseCategoryVisibility();
        }

        function renderExpenseEntries(filteredEntries = null) {
            const listContainer = document.querySelector('#expense-list .transaction-list-items');
            const entriesToShow = filteredEntries !== null ? filteredEntries : expenseEntries;

            listContainer.innerHTML = '';
            if (entriesToShow.length === 0) { listContainer.innerHTML += '<p class="no-data">No expense/income records found.</p>'; return; }

            const groupedEntries = {};
            entriesToShow.forEach((entry, index) => { // 'index' here is from filteredEntries, not original
                const dateKey = new Date(entry.date).toISOString().split('T')[0];
                const originalIndex = expenseEntries.findIndex(e => e.id === entry.id); // Find index in original array

                if (!groupedEntries[dateKey]) {
                    groupedEntries[dateKey] = { items: [], typeSummary: { income: 0, expense: 0 } };
                }
                groupedEntries[dateKey].items.push({ ...entry, originalIndex });

                const amount = parseFloat(entry.amount);
                if (entry.type === 'Income') groupedEntries[dateKey].typeSummary.income += amount;
                else groupedEntries[dateKey].typeSummary.expense += amount;
            });

            const sortedDates = Object.keys(groupedEntries).sort().reverse();

            for (const dateKey of sortedDates) {
                const groupData = groupedEntries[dateKey];
                const displayDate = new Date(dateKey).toDateString();
                const summaries = groupData.typeSummary;

                const groupElement = document.createElement('div');
                groupElement.className = 'grouped-transaction';

                groupElement.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(this.parentElement)">
                        <span>${displayDate}</span>
                        <span>Income: ${formatNumber(summaries.income)} | Expense: ${formatNumber(summaries.expense)}</span>
                    </div>
                    <div class="group-details">
                        ${groupData.items.map(item => {
                            const amountClass = item.type === 'Income' ? 'positive' : 'negative';
                            return `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <span class="transaction-type">${item.category}</span>
                                        <span class="transaction-amount ${amountClass}">${formatNumber(item.amount)}</span>
                                    </div>
                                    <div class="transaction-details-mobile">
                                        <span class="transaction-date">${new Date(item.date).toLocaleTimeString()}</span>
                                        <span class="transaction-info-item"><strong>Type:</strong> ${item.type}</span>
                                        <span class="transaction-info-item"><strong>Method:</strong> ${item.paymentMethod}</span>
                                        ${item.note ? `<span class="transaction-info-item"><strong>Note:</strong> ${item.note.length > 50 ? item.note.substring(0, 50) + '...' : item.note}</span>` : ''}
                                    </div>
                                    <div class="transaction-actions">
                                        <button class="action-button-text edit" onclick="editExpenseEntry(${item.originalIndex})"><i class="fas fa-edit"></i></button>
                                        <button class="action-button-text delete" onclick="deleteExpenseEntry(${item.originalIndex})"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                listContainer.appendChild(groupElement);
            }
        }

        function editExpenseEntry(index) {
            if (index < 0 || index >= expenseEntries.length) { showToast("Error loading expense entry for editing.", "error"); return; }
            const entry = expenseEntries[index];

            document.getElementById('expense-date').value = entry.date;
            document.getElementById('expense-type').value = entry.type;

            const categorySelect = document.getElementById('expense-category');
            const categoryOtherInput = document.getElementById('expense-category-other');

            if (entry.category && savedExpenseCategories[entry.category] || !['Rent', 'Sales', 'other'].includes(entry.category)) {
                categorySelect.value = 'other';
                categoryOtherInput.value = entry.category;
                categoryOtherInput.style.display = 'block';
                if (!savedExpenseCategories[entry.category]) {
                    savedExpenseCategories[entry.category] = entry.category;
                    try { localStorage.setItem('moneyManager_savedExpenseCategories', JSON.stringify(savedExpenseCategories)); } catch (e) { console.error("Error saving custom expense category during edit:", e); }
                    addOptionToSelect('expense-category', entry.category);
                }
            } else if (entry.category) {
                categorySelect.value = entry.category;
                categoryOtherInput.style.display = 'none'; categoryOtherInput.value = '';
            } else {
                categorySelect.value = 'Rent';
                categoryOtherInput.style.display = 'none'; categoryOtherInput.value = '';
            }

            document.getElementById('expense-amount').value = formatNumber(entry.amount);

            const paymentMethodSelect = document.getElementById('expense-payment-method');
            const paymentMethodOtherInput = document.getElementById('expense-payment-method-other');
            if (entry.paymentMethod && entry.paymentMethod.trim() !== '' && !['E-Money', 'Cash', 'Other'].includes(entry.paymentMethod)) {
                 paymentMethodSelect.value = 'Other';
                 paymentMethodOtherInput.value = entry.paymentMethod;
                 paymentMethodOtherInput.style.display = 'block';
            } else if (entry.paymentMethod) {
                 paymentMethodSelect.value = entry.paymentMethod;
                 paymentMethodOtherInput.style.display = 'none'; paymentMethodOtherInput.value = '';
            } else {
                 paymentMethodSelect.value = 'E-Money';
                 paymentMethodOtherInput.style.display = 'none'; paymentMethodOtherInput.value = '';
            }

            document.getElementById('expense-note').value = entry.note || '';
            updateExpenseCategoryVisibility();

            expenseEntries.splice(index, 1); // Remove from array for editing
            updateExpenseSummaries(); renderExpenseEntries();
            showToast('Expense/Income entry loaded for editing');
            window.scrollTo(0, 0);
        }

        function deleteExpenseEntry(index) {
            if (index < 0 || index >= expenseEntries.length) { showToast("Error deleting expense entry.", "error"); return; }
            if (confirm('Are you sure you want to delete this entry?')) {
                expenseEntries.splice(index, 1);
                try {
                    localStorage.setItem('moneyManager_expenseEntries', JSON.stringify(expenseEntries));
                    showToast('Entry deleted successfully', 'success');
                } catch (e) {
                    console.error("Error saving expense entries after delete:", e);
                    showToast('Error saving changes after deletion', 'error');
                }
                updateExpenseSummaries(); renderExpenseEntries();
            }
        }

        function filterExpenses() {
            const typeFilter = document.getElementById('expense-filter-type').value;
            const categoryFilter = document.getElementById('expense-filter-category').value.toLowerCase();
            const dateFilterValue = document.getElementById('expense-filter-date').value;

            let filtered = expenseEntries;

            if (typeFilter !== 'all') filtered = filtered.filter(entry => entry.type === typeFilter);
            if (categoryFilter) filtered = filtered.filter(entry => entry.category.toLowerCase().includes(categoryFilter));
            if (dateFilterValue) {
                try {
                    const filterDate = new Date(dateFilterValue); filterDate.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(entry => {
                        const entryDateTime = new Date(entry.date);
                        if (isNaN(entryDateTime.getTime())) return false;
                        return entryDateTime.getFullYear() === filterDate.getFullYear() &&
                               entryDateTime.getMonth() === filterDate.getMonth() &&
                               entryDateTime.getDate() === filterDate.getDate();
                    });
                } catch (e) { console.error("Error applying date filter for expenses:", e); showToast("Error applying date filter.", "error"); filtered = []; }
            }

            renderExpenseEntries(filtered);
            updateExpenseSummaries();
        }

        function resetExpenseFilters() {
            document.getElementById('expense-filter-type').value = 'all';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-date').value = '';
            renderExpenseEntries();
            updateExpenseSummaries();
        }

        function updateExpenseSummaries() {
            const dateFilterValue = document.getElementById('expense-filter-date').value;
            let startDate, endDate;

            if (dateFilterValue) {
                const filterDate = new Date(dateFilterValue);
                startDate = new Date(filterDate); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(filterDate); endDate.setHours(23, 59, 59, 999);
            } else {
                const today = new Date();
                startDate = new Date(today); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(today); endDate.setHours(23, 59, 59, 999);
            }

            let dailyIncome = 0; let dailyExpenses = 0;

            expenseEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate >= startDate && entryDate <= endDate) {
                    const amount = parseFloat(entry.amount);
                    if (entry.type === 'Income') dailyIncome += amount;
                    else dailyExpenses += amount;
                }
            });

            const netBalance = dailyIncome - dailyExpenses;

            document.getElementById('daily-total-income').textContent = formatNumber(dailyIncome);
            document.getElementById('daily-total-expenses').textContent = formatNumber(dailyExpenses);
            document.getElementById('daily-net-balance').textContent = formatNumber(netBalance);
            const netBalanceElement = document.getElementById('daily-net-balance');
            netBalanceElement.className = netBalance >= 0 ? 'positive' : 'negative';
        }

        function updatePeriodicalExpenseSummaries() {
            const periodType = document.getElementById('period-type').value;
            const now = new Date();

            let startDate = new Date();
            let endDate = new Date();

            if (periodType === 'week') {
                startDate.setDate(now.getDate() - now.getDay()); startDate.setHours(0, 0, 0, 0);
                endDate.setDate(now.getDate() + (6 - now.getDay())); endDate.setHours(23, 59, 59, 999);
            } else if (periodType === 'month') {
                startDate.setDate(1); startDate.setHours(0, 0, 0, 0);
                endDate.setMonth(now.getMonth() + 1); endDate.setDate(0); endDate.setHours(23, 59, 59, 999);
            } else if (periodType === 'year') {
                startDate.setMonth(0); startDate.setDate(1); startDate.setHours(0, 0, 0, 0);
                endDate.setFullYear(now.getFullYear() + 1); endDate.setMonth(0); endDate.setDate(0); endDate.setHours(23, 59, 59, 999);
            }

            let periodicalIncome = 0; let periodicalExpenses = 0;

            expenseEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate >= startDate && entryDate <= endDate) {
                    const amount = parseFloat(entry.amount);
                    if (entry.type === 'Income') periodicalIncome += amount;
                    else periodicalExpenses += amount;
                }
            });

            const periodicalNetBalance = periodicalIncome - periodicalExpenses;

            document.getElementById('periodical-total-income').textContent = formatNumber(periodicalIncome);
            document.getElementById('periodical-total-expenses').textContent = formatNumber(periodicalExpenses);
            document.getElementById('periodical-net-balance').textContent = formatNumber(periodicalNetBalance);
            const periodicalNetBalanceElement = document.getElementById('periodical-net-balance');
            periodicalNetBalanceElement.className = periodicalNetBalance >= 0 ? 'positive' : 'negative';
        }

        function updateExpenseTabUI() {
            updateExpenseSummaries();
            updatePeriodicalExpenseSummaries();
            renderExpenseEntries();
            updateSummariesBasedOnCurrentView();
        }

        // --- SAVE DATA ON PAGE UNLOAD ---
        window.addEventListener('beforeunload', saveData);
    </script>

    <!-- PWA Service Worker Script (Create a file named pwa-service-worker.js in your root directory) -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/pwa-service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
